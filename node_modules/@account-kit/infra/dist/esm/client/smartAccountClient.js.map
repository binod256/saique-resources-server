{"version":3,"file":"smartAccountClient.js","sourceRoot":"","sources":["../../../src/client/smartAccountClient.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  ChainNotFoundError,\n  clientHeaderTrack,\n  createSmartAccountClient,\n  isSmartAccountWithSigner,\n  type Prettify,\n  type SmartAccountClient,\n  type SmartAccountClientActions,\n  type SmartAccountClientConfig,\n  type SmartAccountClientRpcSchema,\n  type SmartContractAccount,\n  type SmartContractAccountWithSigner,\n  type UserOperationContext,\n} from \"@aa-sdk/core\";\nimport { type Chain } from \"viem\";\nimport {\n  alchemy,\n  convertHeadersToObject,\n  type AlchemyTransport,\n} from \"../alchemyTransport.js\";\nimport { getDefaultUserOperationFeeOptions } from \"../defaults.js\";\nimport { alchemyFeeEstimator } from \"../middleware/feeEstimator.js\";\nimport { alchemyGasAndPaymasterAndDataMiddleware } from \"../middleware/gasManager.js\";\nimport { alchemyUserOperationSimulator } from \"../middleware/userOperationSimulator.js\";\nimport {\n  alchemyActions,\n  type AlchemySmartAccountClientActions,\n} from \"./decorators/smartAccount.js\";\nimport type { AlchemyRpcSchema } from \"./types.js\";\nimport { headersUpdate } from \"../alchemyTrackerHeaders.js\";\nimport type { PolicyToken } from \"../middleware/gasManager.js\";\n\nexport function getSignerTypeHeader<\n  TAccount extends SmartContractAccountWithSigner,\n>(account: TAccount) {\n  return { \"Alchemy-Aa-Sdk-Signer\": account.getSigner().signerType };\n}\n\n// #region AlchemySmartAccountClientConfig\nexport type AlchemySmartAccountClientConfig<\n  chain extends Chain | undefined = Chain | undefined,\n  account extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  context extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n> = {\n  account?: account;\n  useSimulation?: boolean;\n  policyId?: string | string[];\n  policyToken?: PolicyToken;\n} & Pick<\n  SmartAccountClientConfig<AlchemyTransport, chain, account, context>,\n  | \"customMiddleware\"\n  | \"feeEstimator\"\n  | \"gasEstimator\"\n  | \"signUserOperation\"\n  | \"transport\"\n  | \"chain\"\n  | \"opts\"\n>;\n// #endregion AlchemySmartAccountClientConfig\n\nexport type BaseAlchemyActions<\n  chain extends Chain | undefined = Chain | undefined,\n  account extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  context extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n> = SmartAccountClientActions<chain, account, context> &\n  AlchemySmartAccountClientActions<account, context>;\n\nexport type AlchemySmartAccountClient_Base<\n  chain extends Chain | undefined = Chain | undefined,\n  account extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  actions extends Record<string, unknown> = Record<string, unknown>,\n  context extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n> = Prettify<\n  SmartAccountClient<\n    AlchemyTransport,\n    chain,\n    account,\n    actions & BaseAlchemyActions<chain, account, context>,\n    [...SmartAccountClientRpcSchema, ...AlchemyRpcSchema],\n    context\n  >\n>;\n\nexport type AlchemySmartAccountClient<\n  chain extends Chain | undefined = Chain | undefined,\n  account extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  actions extends Record<string, unknown> = Record<string, unknown>,\n  context extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n> = Prettify<AlchemySmartAccountClient_Base<chain, account, actions, context>>;\n\nexport function createAlchemySmartAccountClient<\n  TChain extends Chain = Chain,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  TContext extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n>(\n  params: AlchemySmartAccountClientConfig<TChain, TAccount, TContext>,\n): AlchemySmartAccountClient<TChain, TAccount, Record<string, never>, TContext>;\n\n/**\n * Creates an Alchemy smart account client using the provided configuration options, including account details, gas manager configuration, and custom middleware.\n *\n * @example\n * ```ts\n * import { createAlchemySmartAccountClient, alchemy } from \"@account-kit/infra\";\n * import { sepolia } from \"@account-kit/infra/chain\";\n *\n * const client = createAlchemySmartAccountClient({\n *  chain: sepolia,\n *  transport: alchemy({ apiKey: \"your-api-key\" }),\n * });\n * ```\n *\n * @param {AlchemySmartAccountClientConfig} config The configuration for creating the Alchemy smart account client\n * @returns {AlchemySmartAccountClient} An instance of `AlchemySmartAccountClient` configured based on the provided options\n */\nexport function createAlchemySmartAccountClient(\n  config: AlchemySmartAccountClientConfig,\n): AlchemySmartAccountClient {\n  if (!config.chain) {\n    throw new ChainNotFoundError();\n  }\n\n  const feeOptions =\n    config.opts?.feeOptions ?? getDefaultUserOperationFeeOptions(config.chain);\n\n  const scaClient = createSmartAccountClient({\n    account: config.account,\n    transport: config.transport,\n    chain: config.chain,\n    type: \"AlchemySmartAccountClient\",\n    opts: {\n      ...config.opts,\n      feeOptions,\n    },\n    feeEstimator: config.feeEstimator ?? alchemyFeeEstimator(config.transport),\n    gasEstimator: config.gasEstimator,\n    customMiddleware: async (struct, args) => {\n      if (isSmartAccountWithSigner(args.account)) {\n        config.transport.updateHeaders(getSignerTypeHeader(args.account));\n      }\n      return config.customMiddleware\n        ? config.customMiddleware(struct, args)\n        : struct;\n    },\n    ...(config.policyId\n      ? alchemyGasAndPaymasterAndDataMiddleware({\n          policyId: config.policyId,\n          policyToken: config.policyToken,\n          transport: config.transport,\n          gasEstimatorOverride: config.gasEstimator,\n          feeEstimatorOverride: config.feeEstimator,\n        })\n      : {}),\n    userOperationSimulator: config.useSimulation\n      ? alchemyUserOperationSimulator(config.transport)\n      : undefined,\n    signUserOperation: config.signUserOperation,\n    addBreadCrumb(breadcrumb: string) {\n      const oldConfig = config.transport.config;\n      const dynamicFetchOptions = config.transport.dynamicFetchOptions;\n      const newTransport = alchemy({ ...oldConfig });\n      newTransport.updateHeaders(\n        headersUpdate(breadcrumb)(\n          convertHeadersToObject(dynamicFetchOptions?.headers),\n        ),\n      );\n      return createAlchemySmartAccountClient({\n        ...config,\n        transport: newTransport,\n      }) as any;\n    },\n  })\n    .extend(alchemyActions)\n    .extend((client_) => ({\n      addBreadcrumb(breadcrumb: string) {\n        return clientHeaderTrack(client_, breadcrumb);\n      },\n    }));\n\n  if (config.account && isSmartAccountWithSigner(config.account)) {\n    config.transport.updateHeaders(getSignerTypeHeader(config.account));\n  }\n\n  return scaClient;\n}\n"]}