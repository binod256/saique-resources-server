{"version":3,"file":"modularAccountV2.js","sourceRoot":"","sources":["../../../../../src/ma-v2/account/modularAccountV2.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  EntryPointDef,\n  SmartAccountSigner,\n  ToSmartContractAccountParams,\n} from \"@aa-sdk/core\";\nimport {\n  getEntryPoint,\n  EntityIdOverrideError,\n  InvalidModularAccountV2Mode,\n  createBundlerClient,\n  getAccountAddress,\n} from \"@aa-sdk/core\";\nimport {\n  concatHex,\n  encodeFunctionData,\n  isAddressEqual,\n  type Address,\n  type Chain,\n  type Hex,\n  type Transport,\n} from \"viem\";\nimport { accountFactoryAbi } from \"../abis/accountFactoryAbi.js\";\nimport {\n  getDefaultMAV2FactoryAddress,\n  getDefaultWebAuthnMAV2FactoryAddress,\n  getDefaultSMAV2BytecodeAddress,\n} from \"../utils.js\";\nimport {\n  type SignerEntity,\n  type ModularAccountV2,\n  createMAv2Base,\n  type WebauthnModularAccountV2,\n} from \"./common/modularAccountV2Base.js\";\nimport { DEFAULT_OWNER_ENTITY_ID } from \"../utils.js\";\nimport { predictModularAccountV2Address } from \"./predictAddress.js\";\nimport type { ToWebAuthnAccountParameters } from \"viem/account-abstraction\";\nimport { parsePublicKey } from \"webauthn-p256\";\nimport {\n  SignerRequiredFor7702Error,\n  SignerRequiredForDefaultError,\n  WebauthnCredentialsRequiredError,\n} from \"../errors.js\";\n\nexport type CreateModularAccountV2Params<\n  TTransport extends Transport = Transport,\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n> = (Pick<\n  ToSmartContractAccountParams<\"ModularAccountV2\", TTransport, Chain, \"0.7.0\">,\n  \"transport\" | \"chain\" | \"accountAddress\"\n> & {\n  signer: TSigner;\n  entryPoint?: EntryPointDef<\"0.7.0\", Chain>;\n  deferredAction?: Hex;\n  signerEntity?: SignerEntity;\n}) &\n  (\n    | {\n        mode?: \"default\";\n        salt?: bigint;\n        factoryAddress?: Address;\n        implementationAddress?: Address;\n        initCode?: Hex;\n      }\n    | {\n        mode: \"7702\";\n      }\n  );\n\nexport type CreateWebauthnModularAccountV2Params<\n  TTransport extends Transport = Transport,\n> = Pick<\n  ToSmartContractAccountParams<\"ModularAccountV2\", TTransport, Chain, \"0.7.0\">,\n  \"transport\" | \"chain\" | \"accountAddress\"\n> & {\n  mode: \"webauthn\";\n  credential: ToWebAuthnAccountParameters[\"credential\"];\n  getFn?: ToWebAuthnAccountParameters[\"getFn\"] | undefined;\n  rpId?: ToWebAuthnAccountParameters[\"rpId\"] | undefined;\n  entryPoint?: EntryPointDef<\"0.7.0\", Chain>;\n  deferredAction?: Hex;\n  signerEntity?: SignerEntity;\n  salt?: bigint;\n  factoryAddress?: Address;\n  initCode?: Hex;\n};\n\nexport async function createModularAccountV2<\n  TTransport extends Transport = Transport,\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n>(\n  config: CreateModularAccountV2Params<TTransport, TSigner>,\n): Promise<ModularAccountV2<TSigner>>;\n\nexport async function createModularAccountV2<\n  TTransport extends Transport = Transport,\n>(\n  config: CreateWebauthnModularAccountV2Params<TTransport>,\n): Promise<WebauthnModularAccountV2>;\n\n/**\n * Creates a ModularAccount V2 account, with the mode depending on the provided \"mode\" field.\n * Possible modes include: \"default\", which is SMA Bytecode, and \"7702\", which is SMA 7702.\n * Handles nonce generation, transaction encoding, and mode variant-specific behavior like initcode construction.\n *\n * @example\n * ```ts twoslash\n * import { createModularAccountV2 } from \"@account-kit/smart-contracts\";\n * import { LocalAccountSigner } from \"@aa-sdk/core\";\n * import { alchemy, sepolia } from \"@account-kit/infra\";\n *\n * const MNEMONIC = \"...\";\n * const RPC_URL = \"...\";\n *\n * const signer = LocalAccountSigner.mnemonicToAccountSigner(MNEMONIC);\n *\n * const chain = sepolia;\n *\n * const transport = alchemy({ rpcUrl: RPC_URL });\n *\n *\n * const modularAccountV2 = await createModularAccountV2({\n *  mode: \"default\", // or \"7702\"\n *  chain,\n *  signer,\n *  transport,\n * });\n * ```\n *\n * @param {CreateModularAccountV2Params | CreateWebauthnModularAccountV2Params} config Configuration parameters for creating a Modular Account V2.\n * @returns {Promise<ModularAccountV2 | WebauthnModularAccountV2>} A promise that resolves to an `ModularAccountV2` providing methods for nonce retrieval, transaction execution, and more.\n */\nexport async function createModularAccountV2<\n  TTransport extends Transport = Transport,\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n>(\n  config:\n    | CreateModularAccountV2Params<TTransport, TSigner>\n    | CreateWebauthnModularAccountV2Params<TTransport>,\n): Promise<ModularAccountV2<TSigner> | WebauthnModularAccountV2> {\n  const {\n    transport,\n    chain,\n    accountAddress: _accountAddress,\n    entryPoint = getEntryPoint(chain, { version: \"0.7.0\" }),\n    signerEntity = {\n      isGlobalValidation: true,\n      entityId: DEFAULT_OWNER_ENTITY_ID,\n    },\n    signerEntity: { entityId = DEFAULT_OWNER_ENTITY_ID } = {},\n    deferredAction,\n  } = config;\n\n  const signer = \"signer\" in config ? config.signer : undefined;\n\n  const credential = \"credential\" in config ? config.credential : undefined;\n\n  const getFn = \"getFn\" in config ? config.getFn : undefined;\n\n  const rpId = \"rpId\" in config ? config.rpId : undefined;\n\n  const client = createBundlerClient({\n    transport,\n    chain,\n  });\n\n  const accountFunctions = await (async () => {\n    switch (config.mode) {\n      case \"webauthn\": {\n        if (!credential) throw new WebauthnCredentialsRequiredError();\n        const publicKey = credential.publicKey;\n        const { x, y } = parsePublicKey(publicKey);\n        const {\n          salt = 0n,\n          factoryAddress = getDefaultWebAuthnMAV2FactoryAddress(),\n          initCode,\n        } = config;\n\n        const getAccountInitCode = async () => {\n          if (initCode) {\n            return initCode;\n          }\n\n          return concatHex([\n            factoryAddress,\n            encodeFunctionData({\n              abi: accountFactoryAbi,\n              functionName: \"createWebAuthnAccount\",\n              args: [x, y, salt, entityId],\n            }),\n          ]);\n        };\n\n        const accountAddress = await getAccountAddress({\n          client,\n          entryPoint,\n          accountAddress: _accountAddress,\n          getAccountInitCode,\n        });\n\n        return {\n          getAccountInitCode,\n          accountAddress,\n        };\n      }\n      case \"7702\": {\n        const getAccountInitCode = async (): Promise<Hex> => {\n          return \"0x\";\n        };\n        if (!signer) throw new SignerRequiredFor7702Error();\n        const signerAddress = await signer.getAddress();\n        const accountAddress = _accountAddress ?? signerAddress;\n        if (\n          entityId === DEFAULT_OWNER_ENTITY_ID &&\n          !isAddressEqual(signerAddress, accountAddress)\n        ) {\n          throw new EntityIdOverrideError();\n        }\n\n        const implementation: Address =\n          \"0x69007702764179f14F51cdce752f4f775d74E139\";\n\n        const getImplementationAddress = async () => implementation;\n\n        return {\n          getAccountInitCode,\n          accountAddress,\n          getImplementationAddress,\n        };\n      }\n      case \"default\":\n      case undefined: {\n        if (!signer) throw new SignerRequiredForDefaultError();\n        const {\n          salt = 0n,\n          factoryAddress = getDefaultMAV2FactoryAddress(chain),\n          implementationAddress = getDefaultSMAV2BytecodeAddress(chain),\n          initCode,\n        } = config;\n\n        const signerAddress = await signer.getAddress();\n\n        const getAccountInitCode = async () => {\n          if (initCode) {\n            return initCode;\n          }\n\n          return concatHex([\n            factoryAddress,\n            encodeFunctionData({\n              abi: accountFactoryAbi,\n              functionName: \"createSemiModularAccount\",\n              args: [await signer.getAddress(), salt],\n            }),\n          ]);\n        };\n\n        const accountAddress =\n          _accountAddress ??\n          predictModularAccountV2Address({\n            factoryAddress,\n            implementationAddress,\n            salt,\n            type: \"SMA\",\n            ownerAddress: signerAddress,\n          });\n\n        return {\n          getAccountInitCode,\n          accountAddress,\n        };\n      }\n      default:\n        assertNever(config);\n    }\n  })();\n\n  if (!signer) {\n    if (!credential) throw new WebauthnCredentialsRequiredError();\n    return await createMAv2Base({\n      source: \"ModularAccountV2\", // TO DO: remove need to pass in source?\n      transport,\n      chain,\n      entryPoint,\n      signerEntity,\n      deferredAction,\n      credential,\n      getFn,\n      rpId,\n      ...accountFunctions,\n    });\n  }\n\n  return await createMAv2Base({\n    source: \"ModularAccountV2\", // TO DO: remove need to pass in source?\n    transport,\n    chain,\n    signer,\n    entryPoint,\n    signerEntity,\n    deferredAction,\n    ...accountFunctions,\n  });\n}\n\n// If we add more valid modes, the switch case branch's mode will no longer be `never`, which will cause a compile time error here and ensure we handle the new type.\nfunction assertNever(_valid: never): never {\n  throw new InvalidModularAccountV2Mode();\n}\n"]}