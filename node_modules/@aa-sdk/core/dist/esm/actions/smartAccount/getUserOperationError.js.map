{"version":3,"file":"getUserOperationError.js","sourceRoot":"","sources":["../../../../src/actions/smartAccount/getUserOperationError.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  fromHex,\n  concat,\n  isAddress,\n  decodeErrorResult,\n  type Chain,\n  type Transport,\n} from \"viem\";\nimport { AccountNotFoundError } from \"../../errors/account.js\";\nimport type { BaseSmartAccountClient } from \"../../client/smartAccountClient\";\nimport type { SmartContractAccount } from \"../../account/smartContractAccount.js\";\nimport type { UserOperationRequest } from \"../../types.js\";\nimport type { EntryPointDef } from \"../../index.js\";\nimport { deepHexlify } from \"../../utils/index.js\";\nimport {\n  packAccountGasLimits,\n  packPaymasterData,\n} from \"../../entrypoint/0.7.js\";\n\n/**\n * Retrieves the error message from an entrypoint for a User Operation.\n *\n * @param {Client<TTransport, TChain, TAccount>} client the smart account client to use for RPC requests\n * @param {UserOperationRequest} request the uo request to get the error for\n * @param {EntryPointDef} entryPoint the entrypoint instance to send the uo to\n * @returns {string} the error message from the entrypoint\n */\nexport async function getUserOperationError<\n  TTransport extends Transport = Transport,\n  TChain extends Chain | undefined = Chain | undefined,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n>(\n  client: BaseSmartAccountClient<TTransport, TChain, TAccount>,\n  request: UserOperationRequest,\n  entryPoint: EntryPointDef,\n) {\n  if (!client.account) {\n    throw new AccountNotFoundError();\n  }\n\n  const uo = deepHexlify(request);\n\n  try {\n    switch (entryPoint.version) {\n      case \"0.6.0\":\n        // TODO\n        break;\n      case \"0.7.0\":\n        await client.simulateContract({\n          address: entryPoint.address,\n          abi: entryPoint.abi,\n          functionName: \"handleOps\",\n          args: [\n            [\n              {\n                sender: client.account.address,\n                nonce: fromHex(uo.nonce, \"bigint\"),\n                initCode:\n                  uo.factory && uo.factoryData\n                    ? concat([uo.factory, uo.factoryData])\n                    : \"0x\",\n                callData: uo.callData,\n                accountGasLimits: packAccountGasLimits({\n                  verificationGasLimit: uo.verificationGasLimit,\n                  callGasLimit: uo.callGasLimit,\n                }),\n                preVerificationGas: fromHex(uo.preVerificationGas, \"bigint\"),\n                gasFees: packAccountGasLimits({\n                  maxPriorityFeePerGas: uo.maxPriorityFeePerGas,\n                  maxFeePerGas: uo.maxFeePerGas,\n                }),\n                paymasterAndData:\n                  uo.paymaster && isAddress(uo.paymaster)\n                    ? packPaymasterData({\n                        paymaster: uo.paymaster,\n                        paymasterVerificationGasLimit:\n                          uo.paymasterVerificationGasLimit,\n                        paymasterPostOpGasLimit: uo.paymasterPostOpGasLimit,\n                        paymasterData: uo.paymasterData,\n                      })\n                    : \"0x\",\n                signature: uo.signature,\n              },\n            ],\n            client.account.address,\n          ],\n        });\n    }\n  } catch (err: any) {\n    if (err?.cause && err?.cause?.raw) {\n      try {\n        const { errorName, args } = decodeErrorResult({\n          abi: entryPoint.abi,\n          data: err.cause.raw,\n        });\n        console.error(`Failed with '${errorName}':`);\n        switch (errorName) {\n          case \"FailedOpWithRevert\":\n          case \"FailedOp\":\n            // TODO: if we pass in abi we could decode and print this too\n            const argsIdx = errorName === \"FailedOp\" ? 1 : 2;\n            console.error(\n              args && args[argsIdx]\n                ? `Smart contract account reverted with error: ${args[argsIdx]}`\n                : \"No revert data from smart contract account\",\n            );\n            break;\n          default:\n            args && args.forEach((arg) => console.error(`\\n${arg}`));\n        }\n        return;\n      } catch (err) {}\n    }\n    console.error(\"Entrypoint reverted with error: \");\n    console.error(err);\n  }\n}\n"]}