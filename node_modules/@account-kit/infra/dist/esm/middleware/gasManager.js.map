{"version":3,"file":"gasManager.js","sourceRoot":"","sources":["../../../src/middleware/gasManager.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  Address,\n  ClientMiddlewareConfig,\n  ClientMiddlewareFn,\n  EntryPointVersion,\n  Multiplier,\n  SmartContractAccount,\n  UserOperationContext,\n  UserOperationFeeOptions,\n  UserOperationOverrides,\n  UserOperationRequest,\n} from \"@aa-sdk/core\";\nimport {\n  bypassPaymasterAndData,\n  ChainNotFoundError,\n  clientHeaderTrack,\n  deepHexlify,\n  defaultGasEstimator,\n  erc7677Middleware,\n  filterUndefined,\n  isBigNumberish,\n  isMultiplier,\n  noopMiddleware,\n  resolveProperties,\n} from \"@aa-sdk/core\";\nimport {\n  fromHex,\n  isHex,\n  type Hex,\n  encodeAbiParameters,\n  encodeFunctionData,\n  parseAbi,\n} from \"viem\";\nimport type { AlchemySmartAccountClient } from \"../client/smartAccountClient.js\";\nimport type { AlchemyTransport } from \"../alchemyTransport.js\";\nimport { alchemyFeeEstimator } from \"./feeEstimator.js\";\nimport type { RequestGasAndPaymasterAndDataRequest } from \"../actions/types.js\";\n\nimport {\n  PermitTypes,\n  EIP7597Abis,\n  ERC20Abis,\n  getAlchemyPaymasterAddress,\n} from \"../gas-manager.js\";\nimport type { PermitMessage, PermitDomain } from \"../gas-manager.js\";\nimport type { MiddlewareClient } from \"@aa-sdk/core\";\nimport { InvalidSignedPermit } from \"../errors/invalidSignedPermit.js\";\n\nexport type PaymasterContext = {\n  policyId: string | string[];\n  erc20Context?: {\n    tokenAddress: Address;\n    maxTokenAmount?: bigint;\n    permit?: Hex;\n  };\n  webhookData?: string;\n};\n\nexport type PolicyToken = {\n  address: Address;\n  maxTokenAmount: bigint;\n  permit?: {\n    paymasterAddress?: Address;\n    autoPermitApproveTo: bigint;\n    autoPermitBelow: bigint;\n    erc20Name: string;\n    version: string;\n  };\n};\n\n/**\n * Paymaster middleware factory that uses Alchemy's Gas Manager for sponsoring\n * transactions. Adheres to the ERC-7677 standardized communication protocol.\n *\n * @example\n *  ```ts\n * import { sepolia, alchemyGasManagerMiddleware } from \"@account-kit/infra\";\n * import { http } from \"viem\";\n *\n * const client = createSmartAccountClient({\n *  transport: http(\"rpc-url\"),\n *  chain: sepolia,\n *  ...alchemyGasManagerMiddleware(\"policyId\")\n * });\n * ```\n *\n * @param {string | string[]} policyId - The policyId (or list of policyIds) for Alchemy's gas manager\n * @param {PolicyToken | undefined} policyToken - The policy token configuration\n * @param {string | undefined} webhookData - The webhook data to include in the request\n * @returns {Pick<ClientMiddlewareConfig, \"dummyPaymasterAndData\" | \"paymasterAndData\">} Partial client middleware configuration containing `dummyPaymasterAndData` and `paymasterAndData`\n */\nexport function alchemyGasManagerMiddleware(\n  policyId: string | string[],\n  policyToken?: PolicyToken,\n  webhookData?: string,\n): Required<\n  Pick<ClientMiddlewareConfig, \"dummyPaymasterAndData\" | \"paymasterAndData\">\n> {\n  const buildContext = async (\n    args: Parameters<ClientMiddlewareFn>[1],\n  ): Promise<PaymasterContext> => {\n    const context: PaymasterContext = { policyId };\n\n    const { account, client } = args;\n    if (!client.chain) {\n      throw new ChainNotFoundError();\n    }\n\n    if (policyToken !== undefined) {\n      context.erc20Context = {\n        tokenAddress: policyToken.address,\n        maxTokenAmount: policyToken.maxTokenAmount,\n      };\n\n      if (policyToken.permit !== undefined) {\n        const permit = await generateSignedPermit(client, account, policyToken);\n        if (permit !== undefined) {\n          context.erc20Context.permit = permit;\n        }\n      } else if (args.context !== undefined) {\n        context.erc20Context.permit = extractSignedPermitFromContext(\n          args.context,\n        );\n      }\n    }\n\n    if (webhookData !== undefined) {\n      context.webhookData = webhookData;\n    }\n\n    return context;\n  };\n  return {\n    dummyPaymasterAndData: async (uo, args) => {\n      const context = await buildContext(args);\n      const baseMiddleware = erc7677Middleware({ context });\n      return baseMiddleware.dummyPaymasterAndData(uo, args);\n    },\n\n    paymasterAndData: async (uo, args) => {\n      const context = await buildContext(args);\n      const baseMiddleware = erc7677Middleware({ context });\n      return baseMiddleware.paymasterAndData(uo, args);\n    },\n  };\n}\n\ninterface AlchemyGasAndPaymasterAndDataMiddlewareParams {\n  policyId: string | string[];\n  policyToken?: PolicyToken;\n  webhookData?: string;\n  transport: AlchemyTransport;\n  gasEstimatorOverride?: ClientMiddlewareFn;\n  feeEstimatorOverride?: ClientMiddlewareFn;\n}\n\n/**\n * Paymaster middleware factory that uses Alchemy's Gas Manager for sponsoring\n * transactions. Uses Alchemy's custom `alchemy_requestGasAndPaymasterAndData`\n * method instead of conforming to the standard ERC-7677 interface. Note that\n * if you use `createAlchemySmartAccountClient`, this middleware is already\n * used by default and you do not need to manually include it.\n *\n * @example\n *  ```ts twoslash\n * import { sepolia, alchemy, alchemyGasAndPaymasterAndDataMiddleware } from \"@account-kit/infra\";\n * import { createSmartAccountClient } from \"@aa-sdk/core\";\n *\n * const client = createSmartAccountClient({\n *  transport: alchemy({ apiKey: \"your-api-key\" }),\n *  chain: sepolia,\n *  ...alchemyGasAndPaymasterAndDataMiddleware({\n *    policyId: \"policyId\",\n *    transport: alchemy({ apiKey: \"your-api-key\" }),\n *  })\n * });\n * ```\n *\n * @param {AlchemyGasAndPaymasterAndDataMiddlewareParams} params configuration params\n * @param {AlchemyGasAndPaymasterAndDataMiddlewareParams.policyId} params.policyId the policyId for Alchemy's gas manager\n * @param {AlchemyGasAndPaymasterAndDataMiddlewareParams.transport} params.transport fallback transport to use for fee estimation when not using the paymaster\n * @param {AlchemyGasAndPaymasterAndDataMiddlewareParams.gasEstimatorOverride} params.gasEstimatorOverride custom gas estimator middleware\n * @param {AlchemyGasAndPaymasterAndDataMiddlewareParams.feeEstimatorOverride} params.feeEstimatorOverride custom fee estimator middleware\n * @returns {Pick<ClientMiddlewareConfig, \"dummyPaymasterAndData\" | \"feeEstimator\" | \"gasEstimator\" | \"paymasterAndData\">} partial client middleware configuration containing `dummyPaymasterAndData`, `feeEstimator`, `gasEstimator`, and `paymasterAndData`\n */\nexport function alchemyGasAndPaymasterAndDataMiddleware(\n  params: AlchemyGasAndPaymasterAndDataMiddlewareParams,\n): Pick<\n  ClientMiddlewareConfig,\n  \"dummyPaymasterAndData\" | \"feeEstimator\" | \"gasEstimator\" | \"paymasterAndData\"\n> {\n  const {\n    policyId,\n    policyToken,\n    transport,\n    webhookData,\n    gasEstimatorOverride,\n    feeEstimatorOverride,\n  } = params;\n  return {\n    dummyPaymasterAndData: async (uo, args) => {\n      if (\n        // No reason to generate dummy data if we are bypassing the paymaster.\n        bypassPaymasterAndData(args.overrides) ||\n        // When using alchemy_requestGasAndPaymasterAndData, there is generally no reason to generate dummy\n        // data. However, if the gas/feeEstimator is overriden, then this option should be enabled.\n        !(gasEstimatorOverride || feeEstimatorOverride)\n      ) {\n        return noopMiddleware(uo, args);\n      }\n\n      // Fall back to the default 7677 dummyPaymasterAndData middleware.\n      return alchemyGasManagerMiddleware(\n        policyId,\n        policyToken,\n        webhookData,\n      ).dummyPaymasterAndData(uo, args);\n    },\n    feeEstimator: (uo, args) => {\n      return feeEstimatorOverride\n        ? feeEstimatorOverride(uo, args)\n        : bypassPaymasterAndData(args.overrides)\n          ? alchemyFeeEstimator(transport)(uo, args)\n          : noopMiddleware(uo, args);\n    },\n    gasEstimator: (uo, args) => {\n      return gasEstimatorOverride\n        ? gasEstimatorOverride(uo, args)\n        : bypassPaymasterAndData(args.overrides)\n          ? defaultGasEstimator(args.client)(uo, args)\n          : noopMiddleware(uo, args);\n    },\n    paymasterAndData: async (\n      uo,\n      {\n        account,\n        client: client_,\n        feeOptions,\n        overrides: overrides_,\n        context: uoContext,\n      },\n    ) => {\n      const client = clientHeaderTrack(client_, \"alchemyFeeEstimator\");\n      if (!client.chain) {\n        throw new ChainNotFoundError();\n      }\n\n      const userOp = deepHexlify(await resolveProperties(uo));\n\n      const overrides: UserOperationOverrides = filterUndefined({\n        maxFeePerGas: overrideField(\n          \"maxFeePerGas\",\n          overrides_ as UserOperationOverrides,\n          feeOptions,\n          userOp,\n        ),\n        maxPriorityFeePerGas: overrideField(\n          \"maxPriorityFeePerGas\",\n          overrides_ as UserOperationOverrides,\n          feeOptions,\n          userOp,\n        ),\n        callGasLimit: overrideField(\n          \"callGasLimit\",\n          overrides_ as UserOperationOverrides,\n          feeOptions,\n          userOp,\n        ),\n        verificationGasLimit: overrideField(\n          \"verificationGasLimit\",\n          overrides_ as UserOperationOverrides,\n          feeOptions,\n          userOp,\n        ),\n        preVerificationGas: overrideField(\n          \"preVerificationGas\",\n          overrides_ as UserOperationOverrides,\n          feeOptions,\n          userOp,\n        ),\n        ...(account.getEntryPoint().version === \"0.7.0\"\n          ? {\n              paymasterVerificationGasLimit: overrideField<\"0.7.0\">(\n                \"paymasterVerificationGasLimit\",\n                overrides_ as UserOperationOverrides<\"0.7.0\">,\n                feeOptions,\n                userOp,\n              ),\n              paymasterPostOpGasLimit: overrideField<\"0.7.0\">(\n                \"paymasterPostOpGasLimit\",\n                overrides_ as UserOperationOverrides<\"0.7.0\">,\n                feeOptions,\n                userOp,\n              ),\n            }\n          : {}),\n      });\n\n      let erc20Context: RequestGasAndPaymasterAndDataRequest[0][\"erc20Context\"] =\n        undefined;\n      if (policyToken !== undefined) {\n        erc20Context = {\n          tokenAddress: policyToken.address,\n          maxTokenAmount: policyToken.maxTokenAmount,\n        };\n        if (policyToken.permit !== undefined) {\n          const permit = await generateSignedPermit(\n            client,\n            account,\n            policyToken,\n          );\n          if (permit !== undefined) {\n            erc20Context.permit = permit;\n          }\n        } else if (uoContext !== undefined) {\n          erc20Context.permit = extractSignedPermitFromContext(uoContext);\n        }\n      }\n\n      const result = await (client as AlchemySmartAccountClient).request({\n        method: \"alchemy_requestGasAndPaymasterAndData\",\n        params: [\n          {\n            policyId,\n            entryPoint: account.getEntryPoint().address,\n            userOperation: userOp,\n            dummySignature: await account.getDummySignature(),\n            overrides,\n            webhookData,\n            ...(erc20Context\n              ? {\n                  erc20Context,\n                }\n              : {}),\n          },\n        ],\n      });\n\n      return {\n        ...uo,\n        ...result,\n      };\n    },\n  };\n}\n\n/**\n * Utility function to override a field in the user operation request with the overrides or fee options\n *\n * @template {EntryPointVersion} TEntryPointVersion\n * @param {keyof UserOperationFeeOptions<TEntryPointVersion>} field the field to override\n * @param {UserOperationOverrides<TEntryPointVersion> | undefined} overrides the overrides object\n * @param {UserOperationFeeOptions<TEntryPointVersion> | undefined} feeOptions the fee options object from the client\n * @param {UserOperationRequest<TEntryPointVersion>} userOperation the user operation request\n * @returns {Hex | Multiplier | undefined} the overridden field value\n */\nconst overrideField = <\n  TEntryPointVersion extends EntryPointVersion = EntryPointVersion,\n>(\n  field: keyof UserOperationFeeOptions<TEntryPointVersion>,\n  overrides: UserOperationOverrides<TEntryPointVersion> | undefined,\n  feeOptions: UserOperationFeeOptions<TEntryPointVersion> | undefined,\n  userOperation: UserOperationRequest<TEntryPointVersion>,\n): Hex | Multiplier | undefined => {\n  let _field = field as keyof UserOperationOverrides<TEntryPointVersion>;\n\n  if (overrides?.[_field] != null) {\n    // one-off absolute override\n    if (isBigNumberish(overrides[_field])) {\n      return deepHexlify(overrides[_field]);\n    }\n    // one-off multiplier overrides\n    else {\n      return {\n        multiplier: Number((overrides[_field] as Multiplier).multiplier),\n      };\n    }\n  }\n\n  // provider level fee options with multiplier\n  if (isMultiplier(feeOptions?.[field])) {\n    return {\n      multiplier: Number((feeOptions![field] as Multiplier).multiplier),\n    };\n  }\n\n  const userOpField =\n    userOperation[field as keyof UserOperationRequest<TEntryPointVersion>];\n  if (isHex(userOpField) && fromHex(userOpField as Hex, \"bigint\") > 0n) {\n    return userOpField;\n  }\n  return undefined;\n};\n\n/**\n * Utility function to generate a signed Permit for erc20 transaction\n *\n * @param {MiddlewareClient} client - The Alchemy smart account client\n * @param {TAccount} account - The smart account instance\n * @param {PolicyToken} policyToken - The policy token configuration\n * @returns {Promise<Hex>} Returns a Promise containing the signed EIP2612 permit\n */\nconst generateSignedPermit = async <TAccount extends SmartContractAccount>(\n  client: MiddlewareClient,\n  account: TAccount,\n  policyToken: PolicyToken,\n): Promise<Hex | undefined> => {\n  if (!client.chain) {\n    throw new ChainNotFoundError();\n  }\n  if (!policyToken.permit) {\n    throw new Error(\"permit is missing\");\n  }\n\n  if (!policyToken.permit?.erc20Name || !policyToken.permit?.version) {\n    throw new Error(\"erc20Name or version is missing\");\n  }\n\n  const paymasterAddress =\n    policyToken.permit.paymasterAddress ??\n    getAlchemyPaymasterAddress(client.chain, account.getEntryPoint().version);\n\n  if (paymasterAddress === undefined || paymasterAddress === \"0x\") {\n    throw new Error(\"no paymaster contract address available\");\n  }\n\n  let allowanceFuture = client.call({\n    to: policyToken.address,\n    data: encodeFunctionData({\n      abi: parseAbi(ERC20Abis),\n      functionName: \"allowance\",\n      args: [account.address, paymasterAddress],\n    }),\n  });\n\n  let nonceFuture = client.call({\n    to: policyToken.address,\n    data: encodeFunctionData({\n      abi: parseAbi(EIP7597Abis),\n      functionName: \"nonces\",\n      args: [account.address],\n    }),\n  });\n\n  const [allowanceResponse, nonceResponse] = await Promise.all([\n    allowanceFuture,\n    nonceFuture,\n  ]);\n\n  if (!allowanceResponse.data) {\n    throw new Error(\"No allowance returned from erc20 contract call\");\n  }\n\n  if (!nonceResponse.data) {\n    throw new Error(\"No nonces returned from erc20 contract call\");\n  }\n\n  const permitLimit = policyToken.permit.autoPermitApproveTo;\n  const currentAllowance: bigint = BigInt(allowanceResponse.data);\n  if (currentAllowance > policyToken.permit.autoPermitBelow) {\n    // no need to generate permit\n    return undefined;\n  }\n\n  const nonce = BigInt(nonceResponse.data);\n\n  const deadline = BigInt(Math.floor(Date.now() / 1000) + 60 * 10);\n\n  const typedPermitData = {\n    types: PermitTypes,\n    primaryType: \"Permit\" as const,\n    domain: {\n      name: policyToken.permit.erc20Name ?? \"\",\n      version: policyToken.permit.version ?? \"\",\n      chainId: BigInt(client.chain.id),\n      verifyingContract: policyToken.address,\n    } satisfies PermitDomain,\n    message: {\n      owner: account.address,\n      spender: paymasterAddress,\n      value: permitLimit as bigint,\n      nonce: nonce,\n      deadline,\n    } satisfies PermitMessage,\n  } as const;\n\n  const signedPermit = await account.signTypedData(typedPermitData);\n  return encodeSignedPermit(permitLimit, deadline, signedPermit);\n};\n\nfunction extractSignedPermitFromContext(\n  context: UserOperationContext,\n): Hex | undefined {\n  if (context.signedPermit === undefined) {\n    return undefined;\n  }\n\n  if (typeof context.signedPermit !== \"object\") {\n    throw new InvalidSignedPermit(\"signedPermit is not an object\");\n  }\n  if (typeof context.signedPermit.value !== \"bigint\") {\n    throw new InvalidSignedPermit(\"signedPermit.value is not a bigint\");\n  }\n  if (typeof context.signedPermit.deadline !== \"bigint\") {\n    throw new InvalidSignedPermit(\"signedPermit.deadline is not a bigint\");\n  }\n  if (!isHex(context.signedPermit.signature)) {\n    throw new InvalidSignedPermit(\"signedPermit.signature is not a hex string\");\n  }\n  return encodeSignedPermit(\n    context.signedPermit.value,\n    context.signedPermit.deadline,\n    context.signedPermit.signature,\n  );\n}\n\nfunction encodeSignedPermit(\n  value: bigint,\n  deadline: bigint,\n  signedPermit: Hex,\n) {\n  return encodeAbiParameters(\n    [{ type: \"uint256\" }, { type: \"uint256\" }, { type: \"bytes\" }],\n    [value, deadline, signedPermit],\n  );\n}\n"]}