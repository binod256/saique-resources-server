{"version":3,"file":"webauthnGasEstimator.js","sourceRoot":"","sources":["../../../../src/middleware/defaults/webauthnGasEstimator.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,oBAAoB,EAAE,MAAM,yBAAyB,CAAC;AAE/D,OAAO,EAAE,mBAAmB,EAAE,MAAM,mBAAmB,CAAC;AACxD,OAAO,EAAY,MAAM,MAAM,CAAC;AAEhC,MAAM,CAAC,MAAM,oBAAoB,GAC/B,sTAAsT,CAAC;AAEzT;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;GAoCG;AACH,MAAM,CAAC,MAAM,oBAAoB,GAG/B,CAAC,YAAiC,EAAE,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,EAAE;IAC9D,MAAM,aAAa,GAAG,YAAY,IAAI,mBAAmB,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;IAEzE,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,IAAI,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC;IACxD,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,oBAAoB,EAAE,CAAC;IACnC,CAAC;IAED,MAAM,UAAU,GAAG,OAAO,CAAC,aAAa,EAAE,CAAC;IAC3C,IAAI,UAAU,CAAC,OAAO,KAAK,OAAO,EAAE,CAAC;QACnC,MAAM,IAAI,KAAK,CACb,2DAA2D,CAC5D,CAAC;IACJ,CAAC;IAED,MAAM,EAAE,GAAG,MAAM,aAAa,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;IAE/C,MAAM,GAAG,GACP,EAAE,CAAC,oBAAoB,YAAY,OAAO;QACxC,CAAC,CAAC,MAAM,EAAE,CAAC,oBAAoB;QAC/B,CAAC,CAAC,CAAC,EAAE,EAAE,oBAAoB,IAAI,EAAE,CAAC,CAAC;IAEvC,IAAI,CAAC,GAAG,EAAE,CAAC;QACT,MAAM,IAAI,KAAK,CACb,gEAAgE,CACjE,CAAC;IACJ,CAAC;IAED,2DAA2D;IAC3D,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,EAAE,IAAI,EAAE,oBAAoB,EAAE,CAAC,CAAC;IAE1E,MAAM,YAAY,GAAY,IAAI,CAAC,CAAC,CAAC,MAAM,CAAC,IAAI,CAAC,KAAK,EAAE,CAAC,CAAC,CAAC,KAAK,CAAC;IAEjE,mHAAmH;IACnH,OAAO;QACL,GAAG,EAAE;QACL,oBAAoB,EAClB,MAAM,CAAC,OAAO,GAAG,KAAK,QAAQ,CAAC,CAAC,CAAC,MAAM,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC;YACnD,CAAC,YAAY,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,CAAC;KACpC,CAAC;AACJ,CAAC,CAAC","sourcesContent":["import { AccountNotFoundError } from \"../../errors/account.js\";\nimport type { ClientMiddlewareFn } from \"../types\";\nimport { defaultGasEstimator } from \"./gasEstimator.js\";\nimport { type Hex } from \"viem\";\n\nexport const rip7212CheckBytecode =\n  \"0x60806040526040517f532eaabd9574880dbf76b9b8cc00832c20a6ec113d682299550d7a6e0f345e25815260056020820152600160408201527f4a03ef9f92eb268cafa601072489a56380fa0dc43171d7712813b3a19a1eb5e560608201527f3e213e28a608ce9a2f4a17fd830c6654018a79b3e0263d91a8ba90622df6f2f0608082015260208160a0836101005afa503d5f823e3d81f3fe\";\n\n/**\n * A middleware function to estimate the gas usage of a user operation when using a Modular Account V2 WebAuthn account. Has an optional custom gas estimator.\n * This function is only compatible with accounts using EntryPoint v0.7.0, and the account must have an implementation address defined in `getImplementationAddress()`.\n *\n * @example\n * ```ts twoslash\n * import {\n *   webauthnGasEstimator,\n *   createSmartAccountClient,\n *   type SmartAccountClient,\n * } from \"@aa-sdk/core\";\n * import {\n *   createModularAccountV2,\n *   type CreateModularAccountV2ClientParams,\n * } from \"@account-kit/smart-contracts\";\n *\n * const credential = {\n *   id: \"credential-id\",\n *   publicKey: \"0x...\",\n * }\n *\n * async function createWebauthnAccountClient(\n *   config: CreateModularAccountV2ClientParams\n * ): Promise<SmartAccountClient> {\n *   const webauthnAccount = await createModularAccountV2({ ...config, mode: \"webauthn\", credential });\n *\n *   return createSmartAccountClient({\n *     account: webAuthnAccount,\n *     gasEstimator: webauthnGasEstimator(config.gasEstimator),\n *     ...config,\n *   });\n * }\n * ```\n *\n * @param {ClientMiddlewareFn} [gasEstimator] Optional custom gas estimator function\n * @returns {ClientMiddlewareFn} A function that takes user operation struct and parameters, estimates gas usage, and returns the user operation with gas limits.\n */\nexport const webauthnGasEstimator: (\n  gasEstimator?: ClientMiddlewareFn,\n) => ClientMiddlewareFn =\n  (gasEstimator?: ClientMiddlewareFn) => async (struct, params) => {\n    const gasEstimator_ = gasEstimator ?? defaultGasEstimator(params.client);\n\n    const account = params.account ?? params.client.account;\n    if (!account) {\n      throw new AccountNotFoundError();\n    }\n\n    const entryPoint = account.getEntryPoint();\n    if (entryPoint.version !== \"0.7.0\") {\n      throw new Error(\n        \"This middleware is only compatible with EntryPoint v0.7.0\",\n      );\n    }\n\n    const uo = await gasEstimator_(struct, params);\n\n    const pvg: bigint | number | Hex | undefined =\n      uo.verificationGasLimit instanceof Promise\n        ? await uo.verificationGasLimit\n        : (uo?.verificationGasLimit ?? 0n);\n\n    if (!pvg) {\n      throw new Error(\n        \"WebauthnGasEstimator: verificationGasLimit is 0 or not defined\",\n      );\n    }\n\n    // perform eth call read check to see if the chain has 7212\n    const { data } = await params.client.call({ data: rip7212CheckBytecode });\n\n    const chainHas7212: boolean = data ? BigInt(data) === 1n : false;\n\n    // TODO: iterate numbers. Aim to have ~1000 gas buffer to account for longer authenticatorDatas and clientDataJSONs\n    return {\n      ...uo,\n      verificationGasLimit:\n        BigInt(typeof pvg === \"string\" ? BigInt(pvg) : pvg) +\n        (chainHas7212 ? 10000n : 300000n),\n    };\n  };\n"]}