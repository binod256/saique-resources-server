{"version":3,"file":"predictAddress.js","sourceRoot":"","sources":["../../../../../src/ma-v2/account/predictAddress.ts"],"names":[],"mappings":"AAAA,OAAO,EACL,YAAY,EACZ,kBAAkB,EAClB,SAAS,GAGV,MAAM,MAAM,CAAC;AA0Bd;;;;;;;;;;;;;;;;;;GAkBG,CAAC,MAAM,UAAU,8BAA8B,CAChD,MAA4C;IAE5C,MAAM,EAAE,cAAc,EAAE,IAAI,EAAE,qBAAqB,EAAE,GAAG,MAAM,CAAC;IAE/D,IAAI,YAAiB,CAAC;IACtB,IAAI,QAAa,CAAC;IAElB,qHAAqH;IACrH,0KAA0K;IAC1K,QAAQ,MAAM,CAAC,IAAI,EAAE,CAAC;QACpB,KAAK,KAAK;YACR,gDAAgD;YAChD,YAAY,GAAG,iBAAiB,CAAC,MAAM,CAAC,YAAY,EAAE,IAAI,EAAE,UAAU,CAAC,CAAC;YACxE,MAAM,aAAa,GAAG,MAAM,CAAC,YAAY,CAAC;YAC1C,QAAQ,GAAG,iCAAiC,CAC1C,qBAAqB,EACrB,aAAa,CACd,CAAC;YACF,MAAM;QACR,KAAK,IAAI;YACP,YAAY,GAAG,iBAAiB,CAC9B,MAAM,CAAC,YAAY,EACnB,IAAI,EACJ,MAAM,CAAC,QAAQ,CAChB,CAAC;YAEF,QAAQ,GAAG,gBAAgB,CAAC,qBAAqB,CAAC,CAAC;YACnD,MAAM;QACR,KAAK,UAAU;YACb,MAAM,EACJ,cAAc,EAAE,EAAE,CAAC,EAAE,CAAC,EAAE,GACzB,GAAG,MAAM,CAAC;YAEX,YAAY,GAAG,SAAS,CACtB,YAAY,CACV,CAAC,SAAS,EAAE,SAAS,EAAE,SAAS,EAAE,QAAQ,CAAC,EAC3C,CAAC,CAAC,EAAE,CAAC,EAAE,IAAI,EAAE,MAAM,CAAC,QAAQ,CAAC,CAC9B,CACF,CAAC;YAEF,QAAQ,GAAG,gBAAgB,CAAC,qBAAqB,CAAC,CAAC;YAEnD,MAAM;QACR;YACE,OAAO,+BAA+B,CAAC,MAAM,CAAC,CAAC;IACnD,CAAC;IAED,OAAO,kBAAkB,CAAC;QACxB,IAAI,EAAE,cAAc;QACpB,MAAM,EAAE,SAAS;QACjB,IAAI,EAAE,YAAY;QAClB,QAAQ,EAAE,QAAQ;KACnB,CAAC,CAAC;AACL,CAAC;AAED,SAAS,iBAAiB,CACxB,YAAqB,EACrB,IAAY,EACZ,QAAgB;IAEhB,OAAO,SAAS,CACd,YAAY,CACV,CAAC,SAAS,EAAE,SAAS,EAAE,QAAQ,CAAC,EAChC,CAAC,YAAY,EAAE,IAAI,EAAE,QAAQ,CAAC,CAC/B,CACF,CAAC;AACJ,CAAC;AAED,SAAS,gBAAgB,CAAC,qBAA8B;IACtD,OAAO,uBAAuB,qBAAqB,CAAC,KAAK,CACvD,CAAC,CACF,sIAAsI,CAAC;AAC1I,CAAC;AAED,SAAS,iCAAiC,CACxC,qBAA8B,EAC9B,aAAkB;IAElB,OAAO,yBAAyB,qBAAqB,CAAC,KAAK,CACzD,CAAC,CACF,uIAAuI,aAAa,CAAC,KAAK,CACzJ,CAAC,CACF,EAAE,CAAC;AACN,CAAC;AAED,SAAS,+BAA+B,CAAC,CAAQ;IAC/C,MAAM,IAAI,KAAK,CACb,gEAAgE,CACjE,CAAC;AACJ,CAAC","sourcesContent":["import {\n  encodePacked,\n  getContractAddress,\n  keccak256,\n  type Address,\n  type Hex,\n} from \"viem\";\n\nexport type PredictModularAccountV2AddressParams = {\n  factoryAddress: Address;\n  implementationAddress: Address; // Should be the implementation address of the account type you are predicting the address for.\n  salt: bigint;\n} & (\n  | {\n      type: \"MA\";\n      ownerAddress: Address;\n      entityId: number;\n    }\n  | {\n      type: \"SMA\";\n      ownerAddress: Address;\n    }\n  | {\n      type: \"WebAuthn\";\n      ownerPublicKey: {\n        x: bigint;\n        y: bigint;\n      };\n      entityId: number;\n    }\n);\n\n/**\n * Predicts the address of a modular account V2 based on the provided parameters, which include factory address, salt, and implementation address. This function supports different types of accounts including \"SMA\", \"MA\", and \"WebAuthn\".\n *\n * @example\n * ```ts\n * import { predictModularAccountV2Address } from \"@account-kit/smart-contracts\";\n *\n * const accountAddress = predictModularAccountV2Address({\n *   factoryAddress: \"0xFactoryAddress\" as Address,\n *   implementationAddress: \"0xImplementation\" as Address,\n *   salt: 0n,\n *   type: \"SMA\",\n *   ownerAddress: \"0xOwner\" as Address,\n * });\n * ```\n *\n * @param {PredictModularAccountV2AddressParams} params The parameters for predicting the modular account address, including `factoryAddress`, `salt`, `implementationAddress`, and additional properties based on the account type.\n * @returns {Address} The predicted address for the modular account V2.\n */ export function predictModularAccountV2Address(\n  params: PredictModularAccountV2AddressParams,\n): Address {\n  const { factoryAddress, salt, implementationAddress } = params;\n\n  let combinedSalt: Hex;\n  let initcode: Hex;\n\n  // Note: prediction for MA and WebAuthn is currently untested, because they are not supported as an account type yet.\n  // Prior to using this prediction logic, ensure that the counterfactual computation is correct by updating `predictAddress.test.ts` to include a test for MA and WebAuthn.\n  switch (params.type) {\n    case \"SMA\":\n      // MAv2 factory uses max uint32 for SMA entityId\n      combinedSalt = getCombinedSaltK1(params.ownerAddress, salt, 0xffffffff);\n      const immutableArgs = params.ownerAddress;\n      initcode = getProxyBytecodeWithImmutableArgs(\n        implementationAddress,\n        immutableArgs,\n      );\n      break;\n    case \"MA\":\n      combinedSalt = getCombinedSaltK1(\n        params.ownerAddress,\n        salt,\n        params.entityId,\n      );\n\n      initcode = getProxyBytecode(implementationAddress);\n      break;\n    case \"WebAuthn\":\n      const {\n        ownerPublicKey: { x, y },\n      } = params;\n\n      combinedSalt = keccak256(\n        encodePacked(\n          [\"uint256\", \"uint256\", \"uint256\", \"uint32\"],\n          [x, y, salt, params.entityId],\n        ),\n      );\n\n      initcode = getProxyBytecode(implementationAddress);\n\n      break;\n    default:\n      return assertNeverModularAccountV2Type(params);\n  }\n\n  return getContractAddress({\n    from: factoryAddress,\n    opcode: \"CREATE2\",\n    salt: combinedSalt,\n    bytecode: initcode,\n  });\n}\n\nfunction getCombinedSaltK1(\n  ownerAddress: Address,\n  salt: bigint,\n  entityId: number,\n): Hex {\n  return keccak256(\n    encodePacked(\n      [\"address\", \"uint256\", \"uint32\"],\n      [ownerAddress, salt, entityId],\n    ),\n  );\n}\n\nfunction getProxyBytecode(implementationAddress: Address): Hex {\n  return `0x603d3d8160223d3973${implementationAddress.slice(\n    2,\n  )}60095155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f3`;\n}\n\nfunction getProxyBytecodeWithImmutableArgs(\n  implementationAddress: Address,\n  immutableArgs: Hex,\n): Hex {\n  return `0x6100513d8160233d3973${implementationAddress.slice(\n    2,\n  )}60095155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f3${immutableArgs.slice(\n    2,\n  )}`;\n}\n\nfunction assertNeverModularAccountV2Type(_: never): never {\n  throw new Error(\n    \"Unknown modular account type in predictModularAccountV2Address\",\n  );\n}\n"]}