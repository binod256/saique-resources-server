{"version":3,"file":"7702gasEstimator.js","sourceRoot":"","sources":["../../../../src/middleware/defaults/7702gasEstimator.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,SAAS,EAAE,WAAW,EAAE,QAAQ,EAAE,MAAM,MAAM,CAAC;AACxD,OAAO,EAAE,oBAAoB,EAAE,MAAM,yBAAyB,CAAC;AAG/D,OAAO,EAAE,mBAAmB,EAAE,MAAM,mBAAmB,CAAC;AAExD;;;;;;;;GAQG;AACH,MAAM,CAAC,MAAM,uBAAuB,GAGlC,CAAC,YAAiC,EAAE,EAAE,CAAC,KAAK,EAAE,MAAM,EAAE,MAAM,EAAE,EAAE;IAC9D,MAAM,aAAa,GAAG,YAAY,IAAI,mBAAmB,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC;IAEzE,MAAM,OAAO,GAAG,MAAM,CAAC,OAAO,IAAI,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC;IACxD,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,oBAAoB,EAAE,CAAC;IACnC,CAAC;IAED,MAAM,UAAU,GAAG,OAAO,CAAC,aAAa,EAAE,CAAC;IAC3C,IAAI,UAAU,CAAC,OAAO,KAAK,OAAO,EAAE,CAAC;QACnC,MAAM,IAAI,KAAK,CACb,2DAA2D,CAC5D,CAAC;IACJ,CAAC;IAED,MAAM,CAAC,qBAAqB,EAAE,IAAI,GAAG,IAAI,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;QAC7D,OAAO,CAAC,wBAAwB,EAAE;QAClC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,EAAE,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,OAAO,EAAE,CAAC;KAC3D,CAAC,CAAC;IAEH,MAAM,kBAAkB,GACtB,IAAI,CAAC,WAAW,EAAE,KAAK,SAAS,CAAC,CAAC,UAAU,EAAE,qBAAqB,CAAC,CAAC,CAAC;IAExE,IAAI,CAAC,kBAAkB,EAAE,CAAC;QACvB,MAAuC,CAAC,WAAW,GAAG;YACrD,OAAO,EAAE,WAAW,CAAC,MAAM,CAAC,MAAM,CAAC,KAAK,EAAE,EAAE,IAAI,CAAC,CAAC;YAClD,KAAK,EAAE,WAAW,CAChB,MAAM,MAAM,CAAC,MAAM,CAAC,mBAAmB,CAAC;gBACtC,OAAO,EAAE,MAAM,CAAC,OAAO,CAAC,OAAO;aAChC,CAAC,CACH;YACD,OAAO,EAAE,qBAAqB;YAC9B,CAAC,EAAE,QAAQ,EAAE,mBAAmB;YAChC,CAAC,EAAE,QAAQ;YACX,OAAO,EAAE,KAAK;SACf,CAAC;IACJ,CAAC;IAED,OAAO,aAAa,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;AACvC,CAAC,CAAC","sourcesContent":["import { concatHex, numberToHex, zeroHash } from \"viem\";\nimport { AccountNotFoundError } from \"../../errors/account.js\";\nimport type { UserOperationStruct } from \"../../types.js\";\nimport type { ClientMiddlewareFn } from \"../types\";\nimport { defaultGasEstimator } from \"./gasEstimator.js\";\n\n/**\n * A middleware function to estimate the gas usage of a user operation when using an EIP-7702 delegated account. Has an optional custom gas estimator.\n * This function is only compatible with accounts using EntryPoint v0.7.0, and the account must have an implementation address defined in `getImplementationAddress()`.\n *\n * @deprecated The EIP-7702 auth is now set in initUserOperation instead. This middleware is no longer necessary.\n *\n * @param {ClientMiddlewareFn} gasEstimator Optional custom gas estimator function\n * @returns {ClientMiddlewareFn} A function that takes user operation struct and parameters, estimates gas usage, and returns the user operation with gas limits.\n */\nexport const default7702GasEstimator: (\n  gasEstimator?: ClientMiddlewareFn,\n) => ClientMiddlewareFn =\n  (gasEstimator?: ClientMiddlewareFn) => async (struct, params) => {\n    const gasEstimator_ = gasEstimator ?? defaultGasEstimator(params.client);\n\n    const account = params.account ?? params.client.account;\n    if (!account) {\n      throw new AccountNotFoundError();\n    }\n\n    const entryPoint = account.getEntryPoint();\n    if (entryPoint.version !== \"0.7.0\") {\n      throw new Error(\n        \"This middleware is only compatible with EntryPoint v0.7.0\",\n      );\n    }\n\n    const [implementationAddress, code = \"0x\"] = await Promise.all([\n      account.getImplementationAddress(),\n      params.client.getCode({ address: params.account.address }),\n    ]);\n\n    const isAlreadyDelegated =\n      code.toLowerCase() === concatHex([\"0xef0100\", implementationAddress]);\n\n    if (!isAlreadyDelegated) {\n      (struct as UserOperationStruct<\"0.7.0\">).eip7702Auth = {\n        chainId: numberToHex(params.client.chain?.id ?? 0),\n        nonce: numberToHex(\n          await params.client.getTransactionCount({\n            address: params.account.address,\n          }),\n        ),\n        address: implementationAddress,\n        r: zeroHash, // aka `bytes32(0)`\n        s: zeroHash,\n        yParity: \"0x0\",\n      };\n    }\n\n    return gasEstimator_(struct, params);\n  };\n"]}