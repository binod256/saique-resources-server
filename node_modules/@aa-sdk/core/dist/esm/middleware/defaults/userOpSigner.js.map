{"version":3,"file":"userOpSigner.js","sourceRoot":"","sources":["../../../../src/middleware/defaults/userOpSigner.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,oBAAoB,EAAE,MAAM,yBAAyB,CAAC;AAC/D,OAAO,EAAE,kBAAkB,EAAE,MAAM,wBAAwB,CAAC;AAC5D,OAAO,EAAE,yBAAyB,EAAE,MAAM,+BAA+B,CAAC;AAC1E,OAAO,EACL,WAAW,EACX,cAAc,EACd,iBAAiB,GAClB,MAAM,sBAAsB,CAAC;AAE9B,OAAO,EAAgC,WAAW,EAAE,KAAK,EAAE,MAAM,MAAM,CAAC;AACxE,OAAO,EACL,wBAAwB,GAEzB,MAAM,uCAAuC,CAAC;AAC/C,OAAO,EAAE,SAAS,EAAE,MAAM,sBAAsB,CAAC;AAEjD;;;;;;;;;GASG;AACH,MAAM,CAAC,MAAM,mBAAmB,GAAuB,KAAK,EAC1D,MAAM,EACN,EAAE,MAAM,EAAE,OAAO,GAAG,MAAM,CAAC,OAAO,EAAE,EACpC,EAAE;IACF,IAAI,CAAC,OAAO,EAAE,CAAC;QACb,MAAM,IAAI,oBAAoB,EAAE,CAAC;IACnC,CAAC;IAED,IAAI,CAAC,MAAM,EAAE,KAAK,EAAE,CAAC;QACnB,MAAM,IAAI,kBAAkB,EAAE,CAAC;IACjC,CAAC;IAED,MAAM,cAAc,GAAG,MAAM,iBAAiB,CAAC,MAAM,CAAC,CAAC;IACvD,MAAM,OAAO,GAAG,WAAW,CAAC,cAAc,CAAC,CAAC;IAC5C,IAAI,CAAC,cAAc,CAAC,OAAO,CAAC,EAAE,CAAC;QAC7B,MAAM,IAAI,yBAAyB,CAAC,cAAc,CAAC,CAAC;IACtD,CAAC;IAED,OAAO;QACL,GAAG,cAAc;QACjB,SAAS,EAAE,MAAM,OAAO,CAAC,qBAAqB,CAC5C,OAAO,CAAC,aAAa,EAAE,CAAC,oBAAoB,CAAC,OAAO,CAAC,CACtD;QACD,GAAG,CAAC,cAAc,CAAC,WAAW,IAAI;YAChC,WAAW,EAAE,MAAM,iBAAiB,CAAC,OAAO,EAAE,cAAc,CAAC,WAAW,CAAC;SAC1E,CAAC;KACH,CAAC;AACJ,CAAC,CAAC;AAEF,MAAM,iBAAiB,GAAG,KAAK,EAC7B,OAA6B,EAC7B,qBAAgD,EAChD,EAAE;IACF,IAAI,CAAC,OAAO,IAAI,CAAC,wBAAwB,CAAC,OAAO,CAAC,EAAE,CAAC;QACnD,MAAM,IAAI,oBAAoB,EAAE,CAAC;IACnC,CAAC;IAED,MAAM,MAAM,GAAG,OAAO,CAAC,SAAS,EAAE,CAAC;IACnC,IAAI,CAAC,MAAM,CAAC,iBAAiB,EAAE,CAAC;QAC9B,MAAM,IAAI,SAAS,CACjB,0EAA0E,CAC3E,CAAC;IACJ,CAAC;IAED,MAAM,mBAAmB,GAAG,MAAM,MAAM,CAAC,iBAAiB,CAAC;QACzD,OAAO,EAAE,WAAW,CAAC,qBAAqB,CAAC,OAAO,CAAC;QACnD,eAAe,EAAE,qBAAqB,CAAC,OAAO;QAC9C,KAAK,EAAE,WAAW,CAAC,qBAAqB,CAAC,KAAK,CAAC;KAChD,CAAC,CAAC;IAEH,OAAO;QACL,OAAO,EAAE,KAAK,CAAC,mBAAmB,CAAC,OAAO,CAAC;QAC3C,KAAK,EAAE,KAAK,CAAC,mBAAmB,CAAC,KAAK,CAAC;QACvC,OAAO,EAAE,mBAAmB,CAAC,OAAO;QACpC,CAAC,EAAE,mBAAmB,CAAC,CAAC;QACxB,CAAC,EAAE,mBAAmB,CAAC,CAAC;QACxB,OAAO,EAAE,KAAK,CAAC,mBAAmB,CAAC,OAAO,IAAI,mBAAmB,CAAC,CAAC,GAAG,GAAG,CAAC;KAC3E,CAAC;AACJ,CAAC,CAAC","sourcesContent":["import { AccountNotFoundError } from \"../../errors/account.js\";\nimport { ChainNotFoundError } from \"../../errors/client.js\";\nimport { InvalidUserOperationError } from \"../../errors/useroperation.js\";\nimport {\n  deepHexlify,\n  isValidRequest,\n  resolveProperties,\n} from \"../../utils/index.js\";\nimport type { ClientMiddlewareFn } from \"../types\";\nimport { type Authorization, type Hex, hexToNumber, toHex } from \"viem\";\nimport {\n  isSmartAccountWithSigner,\n  type SmartContractAccount,\n} from \"../../account/smartContractAccount.js\";\nimport { BaseError } from \"../../errors/base.js\";\n\n/**\n * Provides a default middleware function for signing user operations with a client account. This function validates the request and adds the signature to it.\n * This is already included in the client returned from `createSmartAccountClient`\n *\n * @param {UserOperationStruct} struct The user operation structure to be signed\n * @param {*} context The middleware context containing the client and account information\n * @param {Client} context.client The client object, which should include account and chain information\n * @param {Account} [context.account] Optional, the account used for signing, defaults to the client's account if not provided\n * @returns {Promise<UserOperationStruct>} A promise that resolves to the signed user operation structure\n */\nexport const defaultUserOpSigner: ClientMiddlewareFn = async (\n  struct,\n  { client, account = client.account },\n) => {\n  if (!account) {\n    throw new AccountNotFoundError();\n  }\n\n  if (!client?.chain) {\n    throw new ChainNotFoundError();\n  }\n\n  const resolvedStruct = await resolveProperties(struct);\n  const request = deepHexlify(resolvedStruct);\n  if (!isValidRequest(request)) {\n    throw new InvalidUserOperationError(resolvedStruct);\n  }\n\n  return {\n    ...resolvedStruct,\n    signature: await account.signUserOperationHash(\n      account.getEntryPoint().getUserOperationHash(request),\n    ),\n    ...(resolvedStruct.eip7702Auth && {\n      eip7702Auth: await signAuthorization(account, resolvedStruct.eip7702Auth),\n    }),\n  };\n};\n\nconst signAuthorization = async (\n  account: SmartContractAccount,\n  unsignedAuthorization: Authorization<Hex, false>,\n) => {\n  if (!account || !isSmartAccountWithSigner(account)) {\n    throw new AccountNotFoundError();\n  }\n\n  const signer = account.getSigner();\n  if (!signer.signAuthorization) {\n    throw new BaseError(\n      \"Signer must implement signAuthorization to sign EIP-7702 authorizations.\",\n    );\n  }\n\n  const signedAuthorization = await signer.signAuthorization({\n    chainId: hexToNumber(unsignedAuthorization.chainId),\n    contractAddress: unsignedAuthorization.address,\n    nonce: hexToNumber(unsignedAuthorization.nonce),\n  });\n\n  return {\n    chainId: toHex(signedAuthorization.chainId),\n    nonce: toHex(signedAuthorization.nonce),\n    address: signedAuthorization.address,\n    r: signedAuthorization.r,\n    s: signedAuthorization.s,\n    yParity: toHex(signedAuthorization.yParity ?? signedAuthorization.v - 27n),\n  };\n};\n"]}