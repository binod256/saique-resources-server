{"version":3,"file":"traceHeader.js","sourceRoot":"","sources":["../../../src/utils/traceHeader.ts"],"names":[],"mappings":"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","sourcesContent":["function generateRandomHexString(numBytes: number) {\n  const hexPairs = new Array(numBytes).fill(0).map(() =>\n    Math.floor(Math.random() * 16)\n      .toString(16)\n      .padStart(2, \"0\"),\n  );\n  return hexPairs.join(\"\");\n}\n\n/**\n * These are the headers that are used in the trace headers, could be found in the spec\n *\n * @see https://www.w3.org/TR/trace-context/#design-overview\n */\n\nexport const TRACE_HEADER_NAME = \"traceparent\";\n/**\n * These are the headers that are used in the trace headers, could be found in the spec\n *\n * @see https://www.w3.org/TR/trace-context/#design-overview\n */\nexport const TRACE_HEADER_STATE = \"tracestate\";\n\nconst clientTraceId = generateRandomHexString(16);\n/**\n * Some tools that are useful when dealing with the values\n * of the trace header. Follows the W3C trace context standard.\n *\n * @see https://www.w3.org/TR/trace-context/\n */\nexport class TraceHeader {\n  readonly traceId: string;\n  readonly parentId: string;\n  readonly traceFlags: string;\n  readonly traceState: Record<string, string>;\n\n  /**\n   * Initializes a new instance with the provided trace identifiers and state information.\n   *\n   * @param {string} traceId The unique identifier for the trace\n   * @param {string} parentId The identifier of the parent trace\n   * @param {string} traceFlags Flags containing trace-related options\n   * @param {TraceHeader[\"traceState\"]} traceState The trace state information for additional trace context\n   */\n  constructor(\n    traceId: string,\n    parentId: string,\n    traceFlags: string,\n    traceState: TraceHeader[\"traceState\"],\n  ) {\n    this.traceId = traceId;\n    this.parentId = parentId;\n    this.traceFlags = traceFlags;\n    this.traceState = traceState;\n  }\n\n  /**\n   * Creating a default trace id that is a random setup for both trace id and parent id\n   *\n   * @example ```ts\n   * const traceHeader = TraceHeader.fromTraceHeader(headers) || TraceHeader.default();\n   * ```\n   *\n   * @returns {TraceHeader} A default trace header\n   */\n  static default() {\n    return new TraceHeader(\n      clientTraceId,\n      generateRandomHexString(8),\n      \"00\", //Means no flag have been set, and no sampled state https://www.w3.org/TR/trace-context/#trace-flags\n      {},\n    );\n  }\n  /**\n   * Should be able to consume a trace header from the headers of an http request\n   *\n   * @example ```ts\n   * const traceHeader = TraceHeader.fromTraceHeader(headers);\n   * ```\n   *\n   * @param {Record<string,string>} headers The headers from the http request\n   * @returns {TraceHeader | undefined} The trace header object, or nothing if not found\n   */\n  static fromTraceHeader(\n    headers: Record<string, string>,\n  ): TraceHeader | undefined {\n    if (!headers[TRACE_HEADER_NAME]) {\n      return undefined;\n    }\n    const [version, traceId, parentId, traceFlags] =\n      headers[TRACE_HEADER_NAME]?.split(\"-\");\n\n    const traceState =\n      headers[TRACE_HEADER_STATE]?.split(\",\").reduce(\n        (acc, curr) => {\n          const [key, value] = curr.split(\"=\");\n          acc[key] = value;\n          return acc;\n        },\n        {} as Record<string, string>,\n      ) || {};\n    if (version !== \"00\") {\n      console.debug(\n        new Error(\n          `Invalid version for traceheader: ${headers[TRACE_HEADER_NAME]}`,\n        ),\n      );\n      return undefined;\n    }\n    return new TraceHeader(traceId, parentId, traceFlags, traceState);\n  }\n\n  /**\n   * Should be able to convert the trace header to the format that is used in the headers of an http request\n   *\n   * @example ```ts\n   * const traceHeader = TraceHeader.fromTraceHeader(headers) || TraceHeader.default();\n   * const headers = traceHeader.toTraceHeader();\n   * ```\n   *\n   * @returns {{traceparent: string, tracestate: string}} The trace header in the format of a record, used in our http client\n   */\n  toTraceHeader() {\n    return {\n      [TRACE_HEADER_NAME]: `00-${this.traceId}-${this.parentId}-${this.traceFlags}`,\n      [TRACE_HEADER_STATE]: Object.entries(this.traceState)\n        .map(([key, value]) => `${key}=${value}`)\n        .join(\",\"),\n    } as const;\n  }\n\n  /**\n   * Should be able to create a new trace header with a new event in the trace state,\n   *  as the key of the eventName as breadcrumbs appending onto previous breadcrumbs with the - infix if exists. And the\n   * trace parent gets updated as according to the docs\n   *\n   * @example ```ts\n   * const traceHeader = TraceHeader.fromTraceHeader(headers) || TraceHeader.default();\n   * const newTraceHeader = traceHeader.withEvent(\"newEvent\");\n   * ```\n   *\n   * @param {string} eventName The key of the new event\n   * @returns {TraceHeader} The new trace header\n   */\n  withEvent(eventName: string): TraceHeader {\n    const breadcrumbs = this.traceState.breadcrumbs\n      ? `${this.traceState.breadcrumbs}-${eventName}`\n      : eventName;\n    return new TraceHeader(this.traceId, this.parentId, this.traceFlags, {\n      ...this.traceState,\n      breadcrumbs,\n    });\n  }\n}\n"]}