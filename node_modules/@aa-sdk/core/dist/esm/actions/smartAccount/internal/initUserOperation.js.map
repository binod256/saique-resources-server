{"version":3,"file":"initUserOperation.js","sourceRoot":"","sources":["../../../../../src/actions/smartAccount/internal/initUserOperation.ts"],"names":[],"mappings":"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","sourcesContent":["import { type Chain, type Transport, concatHex, toHex, zeroHash } from \"viem\";\nimport {\n  isSmartAccountWithSigner,\n  type GetEntryPointFromAccount,\n  type SmartContractAccount,\n} from \"../../../account/smartContractAccount.js\";\nimport type { BaseSmartAccountClient } from \"../../../client/smartAccountClient.js\";\nimport { AccountNotFoundError } from \"../../../errors/account.js\";\nimport { ChainNotFoundError } from \"../../../errors/client.js\";\nimport type { UserOperationStruct } from \"../../../types.js\";\nimport { conditionalReturn, type Deferrable } from \"../../../utils/index.js\";\nimport type {\n  BuildUserOperationParameters,\n  SendUserOperationParameters,\n  UserOperationContext,\n} from \"../types.js\";\n\n/**\n * Description internal action function of SmartAccountClient for initializing\n * a user operation for the sender account\n *\n * @template {Transport} TTransport\n * @template {Chain | undefined} TChain\n * @template {SmartContractAccount | undefined} TAccount\n * @template {UserOperationContext | undefined} TContext\n * @template {GetEntryPointFromAccount} TEntryPointVersion\n * @param {BaseSmartAccountClient<TTransport, TChain, TAccount>} client smart account client\n * @param {SendUserOperationParameters<TAccount, TContext, TEntryPointVersion> | BuildUserOperationParameters<TAccount, TContext, TEntryPointVersion>} args send user operation parameters\n * @returns {Promise<Deferrable<UserOperationStruct<TEntryPointVersion>>>} initialized user operation struct\n */\nexport async function _initUserOperation<\n  TTransport extends Transport = Transport,\n  TChain extends Chain | undefined = Chain | undefined,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  TContext extends UserOperationContext | undefined =\n    | UserOperationContext\n    | undefined,\n  TEntryPointVersion extends\n    GetEntryPointFromAccount<TAccount> = GetEntryPointFromAccount<TAccount>,\n>(\n  client: BaseSmartAccountClient<TTransport, TChain, TAccount>,\n  args:\n    | SendUserOperationParameters<TAccount, TContext, TEntryPointVersion>\n    | BuildUserOperationParameters<TAccount, TContext, TEntryPointVersion>,\n): Promise<Deferrable<UserOperationStruct<TEntryPointVersion>>> {\n  const { account = client.account, uo, overrides } = args;\n  if (!account) {\n    throw new AccountNotFoundError();\n  }\n\n  if (!client.chain) {\n    throw new ChainNotFoundError();\n  }\n\n  const entryPoint = account.getEntryPoint();\n\n  const callData = Array.isArray(uo)\n    ? account.encodeBatchExecute(uo)\n    : typeof uo === \"string\"\n      ? uo\n      : account.encodeExecute(uo);\n\n  const signature = account.getDummySignature();\n\n  const nonce =\n    overrides?.nonce ?? account.getAccountNonce(overrides?.nonceKey);\n\n  const struct =\n    entryPoint.version === \"0.6.0\"\n      ? ({\n          initCode: account.getInitCode(),\n          sender: account.address,\n          nonce,\n          callData,\n          signature,\n        } as Deferrable<UserOperationStruct<TEntryPointVersion>>)\n      : ({\n          factory: conditionalReturn(\n            account.isAccountDeployed().then((deployed) => !deployed),\n            account.getFactoryAddress,\n          ),\n          factoryData: conditionalReturn(\n            account.isAccountDeployed().then((deployed) => !deployed),\n            account.getFactoryData,\n          ),\n          sender: account.address,\n          nonce,\n          callData,\n          signature,\n        } as Deferrable<UserOperationStruct<TEntryPointVersion>>);\n\n  const is7702 =\n    account.source === \"ModularAccountV2\" &&\n    isSmartAccountWithSigner(account) &&\n    (await account.getSigner().getAddress()).toLowerCase() ===\n      account.address.toLowerCase();\n\n  if (is7702) {\n    if (entryPoint.version !== \"0.7.0\") {\n      throw new Error(\"7702 is only compatible with EntryPoint v0.7.0\");\n    }\n\n    const [implementationAddress, code = \"0x\", nonce] = await Promise.all([\n      account.getImplementationAddress(),\n      client.getCode({ address: account.address }),\n      client.getTransactionCount({ address: account.address }),\n    ]);\n\n    const isAlreadyDelegated =\n      code.toLowerCase() ===\n      concatHex([\"0xef0100\", implementationAddress]).toLowerCase();\n\n    if (!isAlreadyDelegated) {\n      (struct as UserOperationStruct<\"0.7.0\">).eip7702Auth = {\n        chainId: toHex(client.chain.id),\n        nonce: toHex(nonce),\n        address: implementationAddress,\n        r: zeroHash, // aka `bytes32(0)`\n        s: zeroHash,\n        yParity: \"0x0\",\n      };\n    }\n  }\n\n  return struct;\n}\n"]}