{"version":3,"file":"alchemyTrackerHeaders.js","sourceRoot":"","sources":["../../src/alchemyTrackerHeaders.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,iBAAiB,EAAE,MAAM,cAAc,CAAC;AACjD,OAAO,EAAE,kBAAkB,EAAE,MAAM,cAAc,CAAC;AAClD,OAAO,EAAE,WAAW,EAAE,MAAM,cAAc,CAAC;AAE3C;;;;;GAKG;AACH,MAAM,cAAc,GAAG,2BAA2B,CAAC;AAEnD;;;;GAIG;AACH,MAAM,kBAAkB,GAAG,6BAA6B,CAAC;AAEzD;;;;;GAKG;AACH,MAAM,UAAU,2BAA2B,CAAC,CAAW;IACrD,IAAI,CAAC,CAAC;QAAE,OAAO;IACf,IAAI,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC;QAAE,OAAO;IAC7B,IAAI,OAAO,CAAC,KAAK,QAAQ;QAAE,OAAO;IAClC,cAAc,IAAI,CAAC,IAAI,OAAO,CAAC,CAAC,cAAc,CAAC,CAAC;IAChD,kBAAkB,IAAI,CAAC,IAAI,OAAO,CAAC,CAAC,kBAAkB,CAAC,CAAC;IACxD,iBAAiB,IAAI,CAAC,IAAI,OAAO,CAAC,CAAC,iBAAiB,CAAC,CAAC;IACtD,kBAAkB,IAAI,CAAC,IAAI,OAAO,CAAC,CAAC,kBAAkB,CAAC,CAAC;AAC1D,CAAC;AAED,SAAS,QAAQ,CAAC,QAA4B,EAAE,KAAa;IAC3D,IAAI,CAAC,QAAQ;QAAE,OAAO,KAAK,CAAC;IAC5B,OAAO,GAAG,QAAQ,MAAM,KAAK,EAAE,CAAC;AAClC,CAAC;AACD;;;;;;;;;;GAUG;AACH,MAAM,UAAU,aAAa,CAAC,KAAa;IACzC,MAAM,aAAa,GAAG,CAAC,CAAyB,EAAE,EAAE;QAClD,MAAM,WAAW,GAAG,CAClB,WAAW,CAAC,eAAe,CAAC,CAAC,CAAC,IAAI,WAAW,CAAC,OAAO,EAAE,CACxD,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;QACnB,OAAO;YACL,CAAC,cAAc,CAAC,EAAE,WAAW,CAAC,QAAQ;YACtC,GAAG,CAAC;YACJ,CAAC,kBAAkB,CAAC,EAAE,QAAQ,CAAC,CAAC,CAAC,kBAAkB,CAAC,EAAE,KAAK,CAAC;YAC5D,GAAG,WAAW,CAAC,aAAa,EAAE;SAC/B,CAAC;IACJ,CAAC,CAAC;IACF,OAAO,aAAa,CAAC;AACvB,CAAC","sourcesContent":["import { TRACE_HEADER_NAME } from \"@aa-sdk/core\";\nimport { TRACE_HEADER_STATE } from \"@aa-sdk/core\";\nimport { TraceHeader } from \"@aa-sdk/core\";\n\n/**\n * The header that is used to track the trace id.\n * We use a client specific one to not mess with the span tracing of the servers.\n *\n * @see headersUpdate\n */\nconst TRACKER_HEADER = \"X-Alchemy-Client-Trace-Id\";\n\n/**\n * The header that is used to track the breadcrumb.\n *\n * @see headersUpdate\n */\nconst TRACKER_BREADCRUMB = \"X-Alchemy-Client-Breadcrumb\";\n\n/**\n * Remove the tracking headers. This is used in our split transport to ensure that we remove the headers that\n * are not used by the other systems.\n *\n * @param {unknown} x The headers to remove the tracking headers from\n */\nexport function mutateRemoveTrackingHeaders(x?: unknown) {\n  if (!x) return;\n  if (Array.isArray(x)) return;\n  if (typeof x !== \"object\") return;\n  TRACKER_HEADER in x && delete x[TRACKER_HEADER];\n  TRACKER_BREADCRUMB in x && delete x[TRACKER_BREADCRUMB];\n  TRACE_HEADER_NAME in x && delete x[TRACE_HEADER_NAME];\n  TRACE_HEADER_STATE in x && delete x[TRACE_HEADER_STATE];\n}\n\nfunction addCrumb(previous: string | undefined, crumb: string): string {\n  if (!previous) return crumb;\n  return `${previous} > ${crumb}`;\n}\n/**\n * Update the headers with the trace header and breadcrumb.\n *\n * These trace headers are used in the imply ingestion pipeline to trace the request.\n * And the breadcrumb is used to get finer grain details in the trace.\n *\n * Then there are the trace headers that are part of the W3C trace context standard.\n *\n * @param {string} crumb The crumb to add to the breadcrumb\n * @returns {Function} A function that updates the headers\n */\nexport function headersUpdate(crumb: string) {\n  const headerUpdate_ = (x: Record<string, string>) => {\n    const traceHeader = (\n      TraceHeader.fromTraceHeader(x) || TraceHeader.default()\n    ).withEvent(crumb);\n    return {\n      [TRACKER_HEADER]: traceHeader.parentId,\n      ...x,\n      [TRACKER_BREADCRUMB]: addCrumb(x[TRACKER_BREADCRUMB], crumb),\n      ...traceHeader.toTraceHeader(),\n    };\n  };\n  return headerUpdate_;\n}\n"]}