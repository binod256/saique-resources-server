{"version":3,"file":"deferralActions.js","sourceRoot":"","sources":["../../../../../src/ma-v2/actions/deferralActions.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  AccountNotFoundError,\n  InvalidNonceKeyError,\n  EntryPointNotFoundError,\n  type UserOperationCallData,\n  type BatchUserOperationCallData,\n  type UserOperationRequest_v7,\n} from \"@aa-sdk/core\";\nimport {\n  type Address,\n  type Hex,\n  concatHex,\n  maxUint152,\n  encodePacked,\n  size,\n  toHex,\n  encodeDeployData,\n  hexToNumber,\n} from \"viem\";\nimport { entityIdAndNonceReaderBytecode, buildFullNonceKey } from \"../utils.js\";\nimport { entityIdAndNonceReaderAbi } from \"../abis/entityIdAndNonceReader.js\";\nimport type { ModularAccountV2Client } from \"../client/client.js\";\n\nexport type DeferredActionTypedData = {\n  domain: {\n    chainId: number;\n    verifyingContract: Address;\n  };\n  types: {\n    DeferredAction: [\n      { name: \"nonce\"; type: \"uint256\" },\n      { name: \"deadline\"; type: \"uint48\" },\n      { name: \"call\"; type: \"bytes\" },\n    ];\n  };\n  primaryType: \"DeferredAction\";\n  message: {\n    nonce: bigint;\n    deadline: number;\n    call: Hex;\n  };\n};\n\nexport type DeferredActionReturnData = {\n  typedData: DeferredActionTypedData;\n};\n\nexport type CreateDeferredActionTypedDataParams = {\n  callData: Hex;\n  deadline: number;\n  nonce: bigint;\n};\n\nexport type BuildPreSignatureDeferredActionDigestParams = {\n  typedData: DeferredActionTypedData;\n};\n\nexport type BuildUserOperationWithDeferredActionParams = {\n  uo: UserOperationCallData | BatchUserOperationCallData;\n  signaturePrepend: Hex;\n  nonceOverride: bigint;\n};\n\nexport type EntityIdAndNonceParams = {\n  entityId?: number;\n  nonceKey?: bigint;\n  isGlobalValidation: boolean;\n  isDeferredAction?: boolean;\n};\n\nexport type DeferralActions = {\n  createDeferredActionTypedDataObject: (\n    args: CreateDeferredActionTypedDataParams,\n  ) => Promise<DeferredActionReturnData>;\n  buildPreSignatureDeferredActionDigest: (\n    args: BuildPreSignatureDeferredActionDigestParams,\n  ) => Hex;\n  buildUserOperationWithDeferredAction: (\n    args: BuildUserOperationWithDeferredActionParams,\n  ) => Promise<UserOperationRequest_v7>;\n  getEntityIdAndNonce: (\n    args: EntityIdAndNonceParams,\n  ) => Promise<{ nonce: bigint; entityId: number }>;\n};\n\n/**\n * Provides deferred action functionalities for a MA v2 client, ensuring compatibility with `SmartAccountClient`.\n *\n * @param {ModularAccountV2Client} client - The client instance which provides account and sendUserOperation functionality.\n * @returns {object} - An object containing three methods: `createDeferredActionTypedDataObject`, `buildDeferredActionDigest`, and `buildUserOperationWithDeferredAction`.\n */\nexport const deferralActions: (\n  client: ModularAccountV2Client,\n) => DeferralActions = (client: ModularAccountV2Client): DeferralActions => {\n  const createDeferredActionTypedDataObject = async ({\n    callData,\n    deadline,\n    nonce,\n  }: CreateDeferredActionTypedDataParams): Promise<DeferredActionReturnData> => {\n    if (!client.account) {\n      throw new AccountNotFoundError();\n    }\n\n    const entryPoint = client.account.getEntryPoint();\n    if (entryPoint === undefined) {\n      throw new EntryPointNotFoundError(client.chain, \"0.7.0\");\n    }\n\n    return {\n      typedData: {\n        domain: {\n          chainId: await client.getChainId(),\n          verifyingContract: client.account.address,\n        },\n        types: {\n          DeferredAction: [\n            { name: \"nonce\", type: \"uint256\" },\n            { name: \"deadline\", type: \"uint48\" },\n            { name: \"call\", type: \"bytes\" },\n          ],\n        },\n        primaryType: \"DeferredAction\",\n        message: {\n          nonce: nonce,\n          deadline: deadline,\n          call: callData,\n        },\n      },\n    };\n  };\n\n  const buildPreSignatureDeferredActionDigest = ({\n    typedData,\n  }: BuildPreSignatureDeferredActionDigestParams): Hex => {\n    const signerEntity = client.account.signerEntity;\n    const validationLocator =\n      (BigInt(signerEntity.entityId) << 8n) |\n      (signerEntity.isGlobalValidation ? 1n : 0n);\n\n    const encodedCallData = encodePacked(\n      [\"uint168\", \"uint48\", \"bytes\"],\n      [validationLocator, typedData.message.deadline, typedData.message.call],\n    );\n\n    const encodedDataLength = size(encodedCallData);\n    const encodedData = concatHex([\n      toHex(encodedDataLength, { size: 4 }),\n      encodedCallData,\n    ]);\n    return encodedData;\n  };\n\n  /**\n   * Builds a user operation with a deferred action by wrapping buildUserOperation() with a dummy signature override.\n   *\n   * @param {object} args The argument object containing the following:\n   * @param {UserOperationCallData | BatchUserOperationCallData} args.uo The user operation call data to build\n   * @param {Hex} args.signaturePrepend The signature data to prepend to the dummy signature\n   * @param {bigint} args.nonceOverride The nonce to override in the user operation, generally given from the typed data builder\n   * @returns {Promise<UserOperationRequest_v7>} The unsigned user operation request with the deferred action\n   */\n  const buildUserOperationWithDeferredAction = async ({\n    uo,\n    signaturePrepend,\n    nonceOverride,\n  }: BuildUserOperationWithDeferredActionParams): Promise<UserOperationRequest_v7> => {\n    // Check if client.account is defined\n    if (client.account === undefined) {\n      throw new AccountNotFoundError();\n    }\n\n    // Pre-fetch the dummy sig so we can override `client.account.getDummySignature()`\n    const dummySig = await client.account.getDummySignature();\n\n    // Cache the previous dummy signature getter\n    const previousDummySigGetter = client.account.getDummySignature;\n\n    // Override client.account.getDummySignature() so `client.buildUserOperation()` uses the prepended hex and the dummy signature during gas estimation\n    client.account.getDummySignature = () => {\n      return concatHex([signaturePrepend, dummySig as Hex]);\n    };\n\n    const unsignedUo = (await client.buildUserOperation({\n      uo: uo,\n      overrides: {\n        nonce: nonceOverride,\n      },\n    })) as UserOperationRequest_v7;\n\n    // Restore the dummy signature getter\n    client.account.getDummySignature = previousDummySigGetter;\n\n    return unsignedUo;\n  };\n\n  const getEntityIdAndNonce = async ({\n    entityId = 1,\n    nonceKey = 0n,\n    isGlobalValidation,\n    isDeferredAction = true,\n  }: EntityIdAndNonceParams) => {\n    if (!client.account) {\n      throw new AccountNotFoundError();\n    }\n\n    if (nonceKey > maxUint152) {\n      throw new InvalidNonceKeyError(nonceKey);\n    }\n\n    const entryPoint = client.account.getEntryPoint();\n    if (entryPoint === undefined) {\n      throw new EntryPointNotFoundError(client.chain, \"0.7.0\");\n    }\n\n    const bytecode = encodeDeployData({\n      abi: entityIdAndNonceReaderAbi,\n      bytecode: entityIdAndNonceReaderBytecode,\n      args: [\n        client.account.address,\n        entryPoint.address,\n        buildFullNonceKey({\n          nonceKey,\n          entityId,\n          isGlobalValidation,\n          isDeferredAction,\n        }),\n      ],\n    });\n\n    const { data } = await client.call({ data: bytecode });\n    if (!data) {\n      throw new Error(\"No data returned from contract call\");\n    }\n\n    return {\n      nonce: BigInt(data),\n      entityId: hexToNumber(`0x${data.slice(40, 48)}`),\n    };\n  };\n\n  return {\n    createDeferredActionTypedDataObject,\n    buildPreSignatureDeferredActionDigest,\n    buildUserOperationWithDeferredAction,\n    getEntityIdAndNonce,\n  };\n};\n"]}