{"version":3,"file":"feeEstimator.js","sourceRoot":"","sources":["../../../src/middleware/feeEstimator.ts"],"names":[],"mappings":"AACA,OAAO,EACL,8BAA8B,EAC9B,cAAc,EACd,iBAAiB,GAClB,MAAM,cAAc,CAAC;AAGtB;;;;;;;;;;;;;;;;;;;;;;GAsBG;AACH,MAAM,CAAC,MAAM,mBAAmB,GAG9B,CAAC,SAAS,EAAE,EAAE,CACd,KAAK,EAAE,MAAM,EAAE,EAAE,SAAS,EAAE,UAAU,EAAE,MAAM,EAAE,OAAO,EAAE,EAAE,EAAE;IAC3D,MAAM,MAAM,GAAG,iBAAiB,CAAC,OAAO,EAAE,qBAAqB,CAAC,CAAC;IACjE,MAAM,UAAU,GAAG,SAAS,CAAC,EAAE,KAAK,EAAE,MAAM,CAAC,KAAK,EAAE,CAAC,CAAC;IACtD,IAAI,CAAC,KAAK,EAAE,4BAA4B,CAAC,GAAG,MAAM,OAAO,CAAC,GAAG,CAAC;QAC5D,MAAM,CAAC,QAAQ,CAAC,EAAE,QAAQ,EAAE,QAAQ,EAAE,CAAC;QACvC,4GAA4G;QAC5G,UAAU,CAAC,OAAO,CAAC;YACjB,MAAM,EAAE,8BAA8B;YACtC,MAAM,EAAE,EAAE;SACX,CAAC;KACH,CAAC,CAAC;IAEH,MAAM,aAAa,GAAG,KAAK,CAAC,aAAa,CAAC;IAC1C,IAAI,aAAa,IAAI,IAAI,EAAE,CAAC;QAC1B,MAAM,IAAI,KAAK,CAAC,uBAAuB,CAAC,CAAC;IAC3C,CAAC;IAED,MAAM,oBAAoB,GAAG,8BAA8B,CACzD,4BAA4B,EAC5B,SAAS,EAAE,oBAAoB,EAC/B,UAAU,EAAE,oBAAoB,CACjC,CAAC;IACF,MAAM,YAAY,GAAG,8BAA8B,CACjD,cAAc,CAAC,aAAa,EAAE,GAAG,CAAC,GAAG,MAAM,CAAC,oBAAoB,CAAC,EACjE,SAAS,EAAE,YAAY,EACvB,UAAU,EAAE,YAAY,CACzB,CAAC;IAEF,OAAO;QACL,GAAG,MAAM;QACT,oBAAoB;QACpB,YAAY;KACb,CAAC;AACJ,CAAC,CAAC","sourcesContent":["import type { ClientMiddlewareFn } from \"@aa-sdk/core\";\nimport {\n  applyUserOpOverrideOrFeeOption,\n  bigIntMultiply,\n  clientHeaderTrack,\n} from \"@aa-sdk/core\";\nimport type { AlchemyTransport } from \"../alchemyTransport\";\n\n/**\n * Function that estimates the transaction fees using Alchemy methods for a given client.\n * It fetches the latest block and estimates the max priority fee per gas, applying any overrides or fee options provided.\n *\n * @example\n * ```ts\n * import { alchemyFeeEstimator, alchemy } from \"@account-kit/infra\";\n * import { createSmartAccountClient } from \"@aa-sdk/core\";\n *\n * const alchemyTransport = alchemy({\n *  chain: sepolia,\n *  apiKey: \"your-api-key\"\n * });\n *\n * const client = createSmartAccountClient({\n *  feeEstimator: alchemyFeeEstimator(alchemyTransport),\n *  ...otherParams\n * });\n * ```\n *\n * @param {AlchemyTransport} transport An alchemy transport for making Alchemy specific RPC calls\n * @returns {ClientMiddlewareFn} A middleware function that takes a transaction structure and fee options, and returns the augmented structure with estimated fees\n */\nexport const alchemyFeeEstimator: (\n  transport: AlchemyTransport,\n) => ClientMiddlewareFn =\n  (transport) =>\n  async (struct, { overrides, feeOptions, client: client_ }) => {\n    const client = clientHeaderTrack(client_, \"alchemyFeeEstimator\");\n    const transport_ = transport({ chain: client.chain });\n    let [block, maxPriorityFeePerGasEstimate] = await Promise.all([\n      client.getBlock({ blockTag: \"latest\" }),\n      // it is a fair assumption that if someone is using this Alchemy Middleware, then they are using Alchemy RPC\n      transport_.request({\n        method: \"rundler_maxPriorityFeePerGas\",\n        params: [],\n      }),\n    ]);\n\n    const baseFeePerGas = block.baseFeePerGas;\n    if (baseFeePerGas == null) {\n      throw new Error(\"baseFeePerGas is null\");\n    }\n\n    const maxPriorityFeePerGas = applyUserOpOverrideOrFeeOption(\n      maxPriorityFeePerGasEstimate,\n      overrides?.maxPriorityFeePerGas,\n      feeOptions?.maxPriorityFeePerGas,\n    );\n    const maxFeePerGas = applyUserOpOverrideOrFeeOption(\n      bigIntMultiply(baseFeePerGas, 1.5) + BigInt(maxPriorityFeePerGas),\n      overrides?.maxFeePerGas,\n      feeOptions?.maxFeePerGas,\n    );\n\n    return {\n      ...struct,\n      maxPriorityFeePerGas,\n      maxFeePerGas,\n    };\n  };\n"]}