{"version":3,"file":"predictAddress.js","sourceRoot":"","sources":["../../../../../src/light-account/accounts/predictAddress.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  encodeAbiParameters,\n  encodeDeployData,\n  keccak256,\n  getContractAddress,\n  type Address,\n  type Hex,\n  toHex,\n  encodeFunctionData,\n} from \"viem\";\nimport type { LightAccountVersionConfigs } from \"../types\";\nimport { OZ_ERC1967Proxy_ConstructorAbi } from \"../abis/OZ_ERC1967Proxy.js\";\nimport { AccountVersionRegistry } from \"../utils.js\";\nimport { LightAccountAbi_v1 } from \"../abis/LightAccountAbi_v1.js\";\n\nexport type PredictLightAccountAddressParams = {\n  factoryAddress: Address;\n  salt: bigint;\n  ownerAddress: Address;\n  version: keyof LightAccountVersionConfigs[\"LightAccount\"];\n};\n\n/**\n * Predicts the address of a light account based on provided parameters such as factory address, salt, owner address, and version.\n *\n * @param {PredictLightAccountAddressParams} params The parameters required to predict the light account address, including factory address, salt, owner address, and version\n * @returns {Address} The predicted address of the light account calculated based on the provided parameters\n */\nexport function predictLightAccountAddress({\n  factoryAddress,\n  salt,\n  ownerAddress,\n  version,\n}: PredictLightAccountAddressParams): Address {\n  const implementationAddress =\n    // If we aren't using the default factory address, we compute the implementation address from the factory's `create` deployment.\n    // This is accurate for both LA v1 and v2 factories. If we are using the default factory address, we use the implementation address from the registry.\n    factoryAddress !==\n    AccountVersionRegistry.LightAccount[version].addresses.default.factory\n      ? getContractAddress({\n          from: factoryAddress,\n          nonce: 1n,\n        })\n      : AccountVersionRegistry.LightAccount[version].addresses.default.impl;\n\n  switch (version) {\n    case \"v1.0.1\":\n    case \"v1.0.2\":\n    case \"v1.1.0\":\n      // Same proxy initcode for all LA v1 factories\n      const LAv1_proxy_bytecode: Hex =\n        \"0x60406080815261042c908138038061001681610218565b93843982019181818403126102135780516001600160a01b038116808203610213576020838101516001600160401b0394919391858211610213570186601f820112156102135780519061007161006c83610253565b610218565b918083528583019886828401011161021357888661008f930161026e565b813b156101b9577f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc80546001600160a01b031916841790556000927fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b8480a28051158015906101b2575b61010b575b855160e790816103458239f35b855194606086019081118682101761019e578697849283926101889952602788527f416464726573733a206c6f772d6c6576656c2064656c65676174652063616c6c87890152660819985a5b195960ca1b8a8901525190845af4913d15610194573d9061017a61006c83610253565b91825281943d92013e610291565b508038808080806100fe565b5060609250610291565b634e487b7160e01b84526041600452602484fd5b50826100f9565b855162461bcd60e51b815260048101859052602d60248201527f455243313936373a206e657720696d706c656d656e746174696f6e206973206e60448201526c1bdd08184818dbdb9d1c9858dd609a1b6064820152608490fd5b600080fd5b6040519190601f01601f191682016001600160401b0381118382101761023d57604052565b634e487b7160e01b600052604160045260246000fd5b6001600160401b03811161023d57601f01601f191660200190565b60005b8381106102815750506000910152565b8181015183820152602001610271565b919290156102f357508151156102a5575090565b3b156102ae5790565b60405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606490fd5b8251909150156103065750805190602001fd5b6044604051809262461bcd60e51b825260206004830152610336815180928160248601526020868601910161026e565b601f01601f19168101030190fdfe60806040523615605f5773ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc54166000808092368280378136915af43d82803e15605b573d90f35b3d90fd5b73ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc54166000808092368280378136915af43d82803e15605b573d90f3fea26469706673582212205da2750cd2b0cadfd354d8a1ca4752ed7f22214c8069d852f7dc6b8e9e5ee66964736f6c63430008150033\";\n\n      return getContractAddress({\n        from: factoryAddress,\n        opcode: \"CREATE2\",\n        salt: toHex(salt, { size: 32 }),\n        bytecode: encodeDeployData({\n          bytecode: LAv1_proxy_bytecode,\n          abi: OZ_ERC1967Proxy_ConstructorAbi,\n          args: [\n            implementationAddress,\n            encodeFunctionData({\n              abi: LightAccountAbi_v1,\n              functionName: \"initialize\",\n              args: [ownerAddress],\n            }),\n          ],\n        }),\n      });\n\n    case \"v2.0.0\":\n      // Logic ported from LA factory v2.0.0\n      const combinedSalt = keccak256(\n        encodeAbiParameters(\n          [{ type: \"address\" }, { type: \"uint256\" }],\n          [ownerAddress, salt],\n        ),\n      );\n\n      const initCode: Hex = getLAv2ProxyBytecode(implementationAddress);\n\n      return getContractAddress({\n        from: factoryAddress,\n        opcode: \"CREATE2\",\n        salt: combinedSalt,\n        bytecode: initCode,\n      });\n\n    default:\n      assertNeverLightAccountVersion(version);\n  }\n}\n\nexport type PredictMultiOwnerLightAccountAddressParams = {\n  factoryAddress: Address;\n  salt: bigint;\n  ownerAddresses: Address[];\n  // There's just one version of the MultiOwnerLightAccount for now, so skip requiring the version as a parameter.\n};\n\n// Note: assumes the owner addresses are already deduped, sorted in ascending order, and have the signer address included.\n/**\n * Predicts the address of a **Multi-Owner Light Account** given the factory, salt\n * and the set of owner addresses.\n *\n * Internally replicates the CREATE2 calculation performed by the factory so\n * you can obtain the counter-factual account address before deployment (useful\n * for funding or displaying to users).\n *\n * @param {PredictMultiOwnerLightAccountAddressParams} params  Object containing:\n *  – `factoryAddress` Factory contract that will deploy the account.\n *  – `salt` Arbitrary salt used when calling the factory.\n *  – `ownerAddresses` Array of owner EOAs (must be deduped & sorted).\n * @returns {Address} Predicted account address for the multi-owner light account.\n */\nexport function predictMultiOwnerLightAccountAddress({\n  factoryAddress,\n  salt,\n  ownerAddresses,\n}: PredictMultiOwnerLightAccountAddressParams): Address {\n  const implementationAddress =\n    // If we aren't using the default factory address, we compute the implementation address from the factory's `create` deployment.\n    // This is accurate for both LA v1 and v2 factories. If we are using the default factory address, we use the implementation address from the registry.\n    factoryAddress !==\n    AccountVersionRegistry.MultiOwnerLightAccount[\"v2.0.0\"].addresses.default\n      .factory\n      ? getContractAddress({\n          from: factoryAddress,\n          nonce: 1n,\n        })\n      : AccountVersionRegistry.MultiOwnerLightAccount[\"v2.0.0\"].addresses\n          .default.impl;\n\n  const combinedSalt = keccak256(\n    encodeAbiParameters(\n      [{ type: \"address[]\" }, { type: \"uint256\" }],\n      [ownerAddresses, salt],\n    ),\n  );\n\n  const initCode: Hex = getLAv2ProxyBytecode(implementationAddress);\n\n  return getContractAddress({\n    from: factoryAddress,\n    opcode: \"CREATE2\",\n    salt: combinedSalt,\n    bytecode: initCode,\n  });\n}\n\n// Bytecode from https://github.com/Vectorized/solady/blob/c6e5238e5f3b621789c59e1a443f43b6606394b2/src/utils/LibClone.sol#L721\n\nfunction getLAv2ProxyBytecode(implementationAddress: Address): Hex {\n  return `0x603d3d8160223d3973${implementationAddress.slice(\n    2,\n  )}60095155f3363d3d373d3d363d7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc545af43d6000803e6038573d6000fd5b3d6000f3`;\n}\n\nfunction assertNeverLightAccountVersion(version: never): never {\n  throw new Error(`Unknown light account version: ${version}`);\n}\n"]}